<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>λ…ΈνΈ κ³µμ  μ‹μ¤ν…</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="./styles.css" />
    
    <!-- Supabase JS λΌμ΄λΈλ¬λ¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- μ¤ν¬λ¦½νΈ νμΌ -->
    <script src="./supabase.js"></script>
    
    
  </head>
  <body>
    <div class="container">
      <!-- ν—¤λ” λ¶€λ¶„: μ§μ›λ²νΈμ™€ μ§μ›λ… ν‘μ‹ -->
      <div class="header" id="headerSection">
        <div class="title">λ…ΈνΈ κ³µμ  μ‹μ¤ν…</div>
        <div class="user-info">
          <span id="userEmployeeNumber">-</span> | <span id="userEmployeeName">-</span>
        </div>
      </div>

      <!-- λ©”μΈ μ»¨ν…μΈ  μμ—­ -->
      <div class="main-content">
        <!-- μΆμΈ΅ μ„Ήμ…: λ…ΈνΈ λ©λ΅ λ° κ²€μƒ‰ -->
        <div class="left-section">
                     <!-- κ²€μƒ‰ μμ—­ -->
           <div class="search-section">
             <div class="search-controls">
               <!-- μ²« λ²μ§Έ μ¤„: λ‚ μ§ λ²”μ„ -->
               <div class="search-row">
                 <div class="search-field">
                   <label>μ‹μ‘μΌ:</label>
                   <input type="date" id="searchStartDate" placeholder="μ‹μ‘μΌ μ„ νƒ">
                 </div>
                 <div class="search-field">
                   <label>μΆ…λ£μΌ:</label>
                   <input type="date" id="searchEndDate" placeholder="μΆ…λ£μΌ μ„ νƒ">
      </div>
    </div>

               <!-- λ‘ λ²μ§Έ μ¤„ -->
               <div class="search-row">
                 <div class="search-field">
                   <label>νƒκ·Έ:</label>
                   <input type="text" id="searchTag" placeholder="νƒκ·Έ κ²€μƒ‰">
                 </div>
                 <div class="search-field">
                   <label>λ…ΈνΈλ‚΄μ©:</label>
                   <input type="text" id="searchContent" placeholder="λ‚΄μ© κ²€μƒ‰">
                 </div>
               </div>
               
               <!-- μ„Έ λ²μ§Έ μ¤„: μ§μ›λ… κ²€μƒ‰ + κ³µκ°μ—¬λ¶€ ν•„ν„° -->
               <div class="search-row">
                 <div class="search-field">
                   <label>μ§μ›λ…:</label>
                   <input type="text" id="searchAuthor" placeholder="μ§μ›λ… κ²€μƒ‰">
                 </div>
                 <div class="privacy-filter">
                   <label>λ³΄κΈ°:</label>
                   <div class="radio-group">
                     <label class="radio-label">
                       <input type="radio" name="privacyFilter" value="public" checked>
                       <span>κ³µκ°λ§</span>
                     </label>
                     <label class="radio-label">
                       <input type="radio" name="privacyFilter" value="all">
                       <span>μ „μ²΄</span>
                     </label>
                   </div>
                 </div>
               </div>
               
               <!-- λ„¤ λ²μ§Έ μ¤„: κ²€μƒ‰ λ²„νΌ -->
               <div class="search-row">
                 <div class="search-buttons">
                   <button id="searchBtn">κ²€μƒ‰</button>
                   <button id="resetBtn">μ΄κΈ°ν™”</button>
                 </div>
               </div>
             </div>
           </div>

          <!-- λ…ΈνΈ λ©λ΅ ν…μ΄λΈ” -->
          <div class="table-section">
            <table id="notesTable">
              <thead>
                <tr>
                  <th class="col-category sortable" data-column="κµ¬λ¶„">κµ¬λ¶„ <span class="sort-arrow"></span></th>
                  <th class="col-date sortable" data-column="λ…ΈνΈλ‚ μ§">λ…ΈνΈλ‚ μ§ <span class="sort-arrow"></span></th>
                  <th class="col-author sortable" data-column="μ§μ›λ…">μ§μ›λ… <span class="sort-arrow"></span></th>
                  <th class="col-number sortable" data-column="λ…ΈνΈλ²νΈ">λ²νΈ <span class="sort-arrow"></span></th>
                  <th class="col-tag sortable" data-column="νƒκ·Έ">νƒκ·Έ <span class="sort-arrow"></span></th>
                  <th class="col-content sortable" data-column="λ…ΈνΈλ‚΄μ©">λ…ΈνΈλ‚΄μ© <span class="sort-arrow"></span></th>
                  <th class="col-privacy sortable" data-column="κ³µκ°μ—¬λ¶€">κ³µκ° <span class="sort-arrow"></span></th>
                </tr>
              </thead>
              <tbody id="notesTableBody">
                <!-- λ™μ μΌλ΅ λ…ΈνΈ λ©λ΅μ΄ λ“¤μ–΄κ° κ³³ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- μ°μΈ΅ μ„Ήμ…: λ…ΈνΈ μ‘μ„± λ° νΈμ§‘ -->
        <div class="right-section">
          <!-- λ…ΈνΈ μ‘μ„± νΌ -->
          <div class="write-form">
            <div class="form-header">
              <h3>λ…ΈνΈ μ‘μ„±</h3>
            </div>
            
            <form id="mainNoteForm" class="main-form">
              <div class="form-group inline-group">
                <label>κµ¬λ¶„:</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="category" value="μ „μ²΄" checked>
                    <span>μ „μ²΄</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="category" value="μ„Όν„°μ¥">
                    <span>μ„Όν„°μ¥</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="category" value="κ°μΈ">
                    <span>κ°μΈ</span>
                  </label>
                </div>
              </div>

              <div class="form-group form-row">
                <div class="form-col inline-group">
                  <label for="mainDate">λ…ΈνΈλ‚ μ§:</label>
                  <input type="date" id="mainDate" required>
                </div>
                <div class="form-col inline-group">
                  <label for="mainNumber">λ…ΈνΈλ²νΈ:</label>
                  <input type="text" id="mainNumber" readonly>
                </div>
              </div>

              <div class="form-group">
                <div class="tag-input-wrapper">
                  <div class="tag-input-row">
                    <label for="mainTag">νƒκ·Έ:</label>
                    <input type="text" id="mainTag" class="tag-input-field" placeholder="νƒκ·Έλ¥Ό μ…λ ¥ν•κ³  Enterλ¥Ό λ„λ¥΄μ„Έμ”">
                    <input type="hidden" id="mainTagHidden">
                  </div>
                  <div class="tag-chips" id="mainTagChips"></div>
                </div>
                <div class="tag-examples">
                  <span class="tag-label">μμ‹ νƒκ·Έ:</span>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="νμ›μƒλ‹΄">νμ›μƒλ‹΄</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="μ¤€λΉ„μ‚¬ν•­">μ¤€λΉ„μ‚¬ν•­</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="νμ›μ΄μ">νμ›μ΄μ</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="λ³΄νΈμμ”μ²­">λ³΄νΈμμ”μ²­</button>
                </div>
              </div>

              <div class="form-group textarea-container">
                <label for="mainContent">λ…ΈνΈλ‚΄μ©:</label>
                <textarea id="mainContent" rows="8" required placeholder="λ…ΈνΈ λ‚΄μ©μ„ μ…λ ¥ν•μ„Έμ”"></textarea>
              </div>
            </form>

            <!-- κ³µκ°μ—¬λ¶€ λ³„λ„ μ»¨ν…μ΄λ„ -->
            <div class="privacy-container">
              <div class="form-group inline-group">
                <label>κ³µκ°μ—¬λ¶€:</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="privacy" value="Y" checked>
                    <span>Y</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="privacy" value="N">
                    <span>N</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- λ²„νΌ μμ—­ -->
            <div class="button-section">
              <button id="resetMainBtn" class="action-btn reset-btn">μ΄κΈ°ν™”</button>
              <button id="saveMainBtn" class="action-btn save-btn">μ €μ¥</button>
              <button id="editMainBtn" class="action-btn edit-btn" disabled>μμ •</button>
              <button id="deleteMainBtn" class="action-btn delete-btn" disabled>μ‚­μ </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- λ¨λ‹¬ μ°½: λ…ΈνΈ μ…λ ¥/μμ • -->
    <div id="noteModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">λ…ΈνΈ μ…λ ¥</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <div class="form-group inline-group">
              <label>κµ¬λ¶„:</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="modalCategory" value="μ „μ²΄" checked>
                  <span>μ „μ²΄</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="modalCategory" value="μ„Όν„°μ¥">
                  <span>μ„Όν„°μ¥</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="modalCategory" value="κ°μΈ">
                  <span>κ°μΈ</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label for="modalDate">λ…ΈνΈλ‚ μ§:</label>
              <input type="date" id="modalDate" required>
            </div>
            <div class="form-group">
              <label for="modalNumber">λ…ΈνΈλ²νΈ:</label>
              <input type="text" id="modalNumber" required>
            </div>
            <div class="form-group">
              <label for="modalTag">νƒκ·Έ:</label>
              <input type="text" id="modalTag" placeholder="μ‰Όν‘(,)λ΅ κµ¬λ¶„ν•μ—¬ μ—¬λ¬ νƒκ·Έ μ…λ ¥">
              <div class="tag-examples">
                <span class="tag-label">μμ‹ νƒκ·Έ:</span>
                <button type="button" class="tag-example-btn" data-tag="νμ›μƒλ‹΄">νμ›μƒλ‹΄</button>
                <button type="button" class="tag-example-btn" data-tag="μ¤€λΉ„μ‚¬ν•­">μ¤€λΉ„μ‚¬ν•­</button>
                <button type="button" class="tag-example-btn" data-tag="νμ›μ΄μ">νμ›μ΄μ</button>
                <button type="button" class="tag-example-btn" data-tag="λ³΄νΈμμ”μ²­">λ³΄νΈμμ”μ²­</button>
              </div>
            </div>
            <div class="form-group">
              <label for="modalContent">λ…ΈνΈλ‚΄μ©:</label>
              <textarea id="modalContent" rows="10" required></textarea>
            </div>
            <div class="form-group inline-group" id="privacyGroup" style="display: none;">
              <label>κ³µκ°μ—¬λ¶€:</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="modalPrivacy" value="Y" checked>
                  <span>Y</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="modalPrivacy" value="N">
                  <span>N</span>
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveBtn" class="action-btn save-btn">μ €μ¥</button>
          <button type="button" id="cancelBtn" class="action-btn cancel-btn">μ·¨μ†</button>
        </div>
      </div>
    </div>

    <!-- μ¨κ²¨μ§„ userInfo μ”μ† (parent pageμ—μ„ μ‚¬λ² κ°€μ Έμ¤κΈ°μ©) -->
    <div id="userInfo" style="display: none;"></div>
    

    
    <!-- Parent νμ΄μ§€μ© ν—¬νΌ μ¤ν¬λ¦½νΈ (Parent νμ΄μ§€μ—μ„ μ΄ μ½”λ“λ¥Ό μ¶”κ°€ν•μ„Έμ”) -->
    <!--
    <script>
      // Parent νμ΄μ§€μ—μ„ λ…ΈνΈ μ•±μΌλ΅ μ‚¬μ©μ μ •λ³΄ μ „λ‹¬ν•λ” λ°©λ²•λ“¤:
      
      // λ°©λ²• 1: userInfo μ”μ†μ— μ§μ›λ²νΈ μ„¤μ • (κ°€μ¥ κ°„λ‹¨)
      function setUserInfoForNoteApp(empNo) {
        const userInfoElement = document.getElementById('userInfo');
        if (userInfoElement) {
          userInfoElement.textContent = empNo;
          console.log('userInfo μ”μ†μ— μ§μ›λ²νΈ μ„¤μ •:', empNo);
        }
      }
      
      // λ°©λ²• 2: sessionStorageμ— μ €μ¥
      function setUserToSession(empNo) {
        sessionStorage.setItem('currentUser', empNo);
        console.log('sessionStorageμ— μ§μ›λ²νΈ μ €μ¥:', empNo);
      }
      
      // λ°©λ²• 3: postMessage μ‘λ‹µ λ¦¬μ¤λ„
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'requestUserInfo') {
          const currentUserEmpNo = getCurrentUserEmpNo(); // μ‹¤μ  μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤λ” ν•¨μ
          event.source.postMessage({
            type: 'userInfo',
            userId: currentUserEmpNo,
            empNo: currentUserEmpNo
          }, '*');
          console.log('postMessageλ΅ μ§μ›λ²νΈ μ „μ†΅:', currentUserEmpNo);
        }
      });
      
      // λ°©λ²• 4: URL νλΌλ―Έν„°λ΅ λ…ΈνΈ μ•± μ—΄κΈ°
      function openNoteAppWithUser(empNo) {
        const noteAppUrl = './note_app.html?empNo=' + encodeURIComponent(empNo);
        // iframeμ΄λ‚ μƒ μ°½μΌλ΅ μ—΄κΈ°
        window.open(noteAppUrl, '_blank');
      }
      
      // μ‹¤μ  μ‚¬μ©μ μ •λ³΄λ¥Ό κ°€μ Έμ¤λ” ν•¨μ (μ‹¤μ  κµ¬ν„ ν•„μ”)
      function getCurrentUserEmpNo() {
        // μ—¬κΈ°μ„ μ‹¤μ  λ΅κ·ΈμΈλ μ‚¬μ©μμ μ§μ›λ²νΈλ¥Ό λ°ν™
        // μ: return document.getElementById('loginUserId').value;
        // μ: return window.currentUser;
        // μ: return sessionStorage.getItem('userEmpNo');
        return 'USER_EMP_NO_HERE'; // μ‹¤μ  κ°’μΌλ΅ κµμ²΄ ν•„μ”
      }
    </script>
    -->

    <script>
      // μ „μ—­ λ³€μ
      let currentUser = '';
      let currentUserName = '';
      let selectedNoteId = null;
      let notes = [];
      let isEditMode = false;
      let isViewMode = false;
      
      // μ§μ› μ •λ³΄ μΊμ‹
      let employeesCache = null;
      let employeesCacheLoaded = false;
      
      // ν…μ΄λΈ” μ •λ ¬ μƒνƒ
      let currentSort = {
        column: null,
        direction: 'asc' // 'asc' λλ” 'desc'
      };
      
      // λ‚ μ§ ν•„ν„° κ΄€λ ¨ λ³€μ
      let cachedNotes = []; // μ„λ²„μ—μ„ κ°€μ Έμ¨ μ›λ³Έ λ°μ΄ν„°
      let currentDateRange = { startDate: '', endDate: '' }; // ν„μ¬ μ„¤μ •λ λ‚ μ§ λ²”μ„

      // ν•κµ­ μ‹κ°„ κΈ°μ¤€ λ‚ μ§ μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤
      function getKoreaDate() {
        const now = new Date();
        const koreaOffset = 9 * 60; // UTC+9 (λ¶„ λ‹¨μ„)
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const koreaTime = new Date(utc + (koreaOffset * 60000));
        return koreaTime;
      }

      function getKoreaDateString(date = null) {
        const koreaDate = date || getKoreaDate();
        return koreaDate.toISOString().split('T')[0]; // yyyy-mm-dd ν•μ‹
      }

      function getKoreaDateStringForDB(date = null) {
        const dateStr = getKoreaDateString(date);
        return dateStr.replace(/-/g, ''); // yyyymmdd ν•μ‹
      }

      function getDateDaysAgo(days) {
        const koreaDate = getKoreaDate();
        koreaDate.setDate(koreaDate.getDate() - days);
        return koreaDate;
      }

      function initializeDateRange() {
        const today = getKoreaDateString();
        const thirtyDaysAgo = getKoreaDateString(getDateDaysAgo(30));
        
        currentDateRange.startDate = thirtyDaysAgo;
        currentDateRange.endDate = today;
        
        return { startDate: thirtyDaysAgo, endDate: today };
      }

      // μ§μ› μ •λ³΄ μ΄κΈ°ν™” λ° μΊμ‹±
      async function initializeEmployeesCache() {
        if (employeesCacheLoaded) {
          return employeesCache;
        }
        
        try {
          console.log('μ§μ› μ •λ³΄ λ΅λ”© μ¤‘...');
          employeesCache = await getEmployeesInfo();
          employeesCacheLoaded = true;
          console.log('μ§μ› μ •λ³΄ λ΅λ”© μ™„λ£:', employeesCache.length, 'λ…');
          
          // λ””λ²„κΉ…: μ²« λ²μ§Έ μ§μ› μ •λ³΄ ν™•μΈ
          if (employeesCache.length > 0) {
            console.log('μ²« λ²μ§Έ μ§μ› μ •λ³΄:', employeesCache[0]);
            console.log('μ§μ›λ²νΈ ν•„λ“λ… ν™•μΈ:', Object.keys(employeesCache[0]));
          }
          
          return employeesCache;
        } catch (error) {
          console.error('μ§μ› μ •λ³΄ λ΅λ”© μ‹¤ν¨:', error);
          employeesCache = [];
          employeesCacheLoaded = true;
          return employeesCache;
        }
      }

      // μΊμ‹λ μ§μ› μ •λ³΄μ—μ„ μ§μ›λ… μ°ΎκΈ°
      function getEmployeeNameFromCache(employeeNumber) {
        if (!employeesCacheLoaded || !employeesCache) {
          console.log('μΊμ‹κ°€ λ΅λ”©λμ§€ μ•μ:', { employeesCacheLoaded, employeesCache });
          return employeeNumber; // μΊμ‹κ°€ λ΅λ”©λμ§€ μ•μ•μΌλ©΄ μ§μ›λ²νΈ λ°ν™
        }
        
        console.log('μ§μ›λ²νΈλ΅ κ²€μƒ‰:', employeeNumber);
        console.log('μΊμ‹μ—μ„ κ²€μƒ‰ μ¤‘...');
        
        // μ •ν™•ν• λ§¤μΉ­ μ‹λ„
        let employee = employeesCache.find(emp => emp.μ§μ›λ²νΈ === employeeNumber);
        
        // μ •ν™•ν• λ§¤μΉ­ μ‹¤ν¨ μ‹ λ€μ†λ¬Έμ λ¬΄μ‹ν•κ³  μ‹λ„
        if (!employee) {
          console.log('μ •ν™•ν• λ§¤μΉ­ μ‹¤ν¨ - λ€μ†λ¬Έμ λ¬΄μ‹ν•κ³  μ¬μ‹λ„');
          employee = employeesCache.find(emp => 
            emp.μ§μ›λ²νΈ && emp.μ§μ›λ²νΈ.toLowerCase() === employeeNumber.toLowerCase()
          );
        }
        
        // κ³µλ°± μ κ±° ν›„ μ‹λ„
        if (!employee) {
          console.log('λ€μ†λ¬Έμ λ§¤μΉ­ μ‹¤ν¨ - κ³µλ°± μ κ±° ν›„ μ¬μ‹λ„');
          const trimmedNumber = employeeNumber.trim();
          employee = employeesCache.find(emp => 
            emp.μ§μ›λ²νΈ && emp.μ§μ›λ²νΈ.trim() === trimmedNumber
          );
        }
        
        console.log('μµμΆ… λ§¤μΉ­ κ²°κ³Ό:', employee);
        return employee ? employee.μ§μ›λ… : employeeNumber;
      }

      // μ „μ²΄ μ§μ› λ©λ΅ κ°€μ Έμ¤κΈ° (μΊμ‹μ—μ„)
      function getAllEmployeesFromCache() {
        if (!employeesCacheLoaded || !employeesCache) {
          return [];
        }
        return employeesCache;
      }

      // μ§μ› μ •λ³΄ μΊμ‹ μƒλ΅κ³ μΉ¨
      async function refreshEmployeesCache() {
        employeesCacheLoaded = false;
        employeesCache = null;
        return await initializeEmployeesCache();
      }

      // λ””λ²„κΉ…μ© μ „μ—­ ν•¨μλ“¤
      window.debugEmployeeCache = function() {
        console.log('=== μ§μ› μΊμ‹ λ””λ²„κΉ… ===');
        console.log('ν„μ¬ μ‚¬μ©μ:', currentUser);
        console.log('μΊμ‹ λ΅λ”© μƒνƒ:', employeesCacheLoaded);
        console.log('μΊμ‹λ μ§μ› μ:', employeesCache ? employeesCache.length : 0);
        
        if (employeesCache && employeesCache.length > 0) {
          console.log('μ „μ²΄ μ§μ› λ©λ΅:', employeesCache);
          
          // ν„μ¬ μ‚¬μ©μ κ²€μƒ‰
          const found = employeesCache.find(emp => emp.μ§μ›λ²νΈ === currentUser);
          console.log('ν„μ¬ μ‚¬μ©μ κ²€μƒ‰ κ²°κ³Ό:', found);
          
          // s25001 κ²€μƒ‰
          const s25001 = employeesCache.find(emp => emp.μ§μ›λ²νΈ === 's25001');
          console.log('s25001 κ²€μƒ‰ κ²°κ³Ό:', s25001);
        }
        
        return {
          currentUser,
          employeesCacheLoaded,
          employeesCount: employeesCache ? employeesCache.length : 0,
          employeesCache
        };
      };

      // μ‚¬μ©μ μ •λ³΄λ¥Ό μ €μ¥μ†μ— μ €μ¥ν•λ” ν•¨μ
      function saveUserInfoToStorage(userInfo) {
        if (userInfo && userInfo.trim()) {
          try {
            // sessionStorageμ— μ—¬λ¬ ν‚¤λ΅ μ €μ¥ (νΈν™μ„±)
            sessionStorage.setItem('currentUser', userInfo.trim());
            sessionStorage.setItem('userInfo', userInfo.trim());
            sessionStorage.setItem('empNo', userInfo.trim());
            
            // localStorageμ—λ„ λ°±μ—… μ €μ¥
            localStorage.setItem('currentUser', userInfo.trim());
            localStorage.setItem('userInfo', userInfo.trim());
            localStorage.setItem('empNo', userInfo.trim());
            
            console.log('π’Ύ μ‚¬μ©μ μ •λ³΄ μ €μ¥ μ™„λ£:', userInfo.trim());
          } catch (error) {
            console.error('μ‚¬μ©μ μ •λ³΄ μ €μ¥ μ—λ¬:', error);
          }
        }
      }

      // μ €μ¥λ μ‚¬μ©μ μ •λ³΄ μ‚­μ  ν•¨μ
      function clearUserInfoFromStorage() {
        try {
          // sessionStorage μ •λ¦¬
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('userInfo');
          sessionStorage.removeItem('empNo');
          
          // localStorage μ •λ¦¬
          localStorage.removeItem('currentUser');
          localStorage.removeItem('userInfo');
          localStorage.removeItem('empNo');
          
          console.log('π—‘οΈ μ €μ¥λ μ‚¬μ©μ μ •λ³΄ μ‚­μ  μ™„λ£');
        } catch (error) {
          console.error('μ‚¬μ©μ μ •λ³΄ μ‚­μ  μ—λ¬:', error);
        }
      }

      // parent pageμ—μ„ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ° ν•¨μ
      async function getUserFromParent() {
        try {
          // λ°©λ²• 0: μ΄λ―Έ currentUserκ°€ μ„¤μ •λμ–΄ μλ‹¤λ©΄ μ¬μ‚¬μ©
          if (currentUser && currentUser.trim()) {
            console.log('π”„ κΈ°μ΅΄ μ‚¬μ©μ μ •λ³΄ μ¬μ‚¬μ©:', currentUser);
            return;
          }

          // λ°©λ²• 1: sessionStorageμ—μ„ λ¨Όμ € ν™•μΈ (μƒλ΅κ³ μΉ¨ λ€μ‘)
          const sessionUser = sessionStorage.getItem('currentUser') || 
                             sessionStorage.getItem('userInfo') || 
                             sessionStorage.getItem('empNo');
          if (sessionUser && sessionUser.trim()) {
            currentUser = sessionUser.trim();
            console.log('β… sessionStorageμ—μ„ μ‚¬μ©μ μ •λ³΄ λ³µμ›:', currentUser);
            // sessionStorageμ— μ €μ¥λ μ •λ³΄λ¥Ό λ‹¤μ‹ μ €μ¥ν•μ—¬ μΌκ΄€μ„± μ μ§€
            saveUserInfoToStorage(currentUser);
            return;
          }

          // λ°©λ²• 2: ν„μ¬ νμ΄μ§€μ userInfo μ”μ†μ—μ„ κ°€μ Έμ¤κΈ°
          const userInfoElement = document.getElementById('userInfo');
          if (userInfoElement && userInfoElement.textContent.trim()) {
            currentUser = userInfoElement.textContent.trim();
            console.log('β… ν„μ¬ νμ΄μ§€ userInfoμ—μ„ κ°€μ Έμ΄:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // λ°©λ²• 3: parent windowμ—μ„ μ§μ ‘ μ ‘κ·Ό
          if (window.parent && window.parent !== window) {
            try {
              const parentUserInfo = window.parent.document.getElementById('userInfo');
              if (parentUserInfo) {
                // data-emp-no μ†μ„±μ—μ„ λ¨Όμ € μ‹λ„
                const empNoFromData = parentUserInfo.getAttribute('data-emp-no');
                if (empNoFromData && empNoFromData.trim()) {
                  currentUser = empNoFromData.trim();
                  console.log('β… parent window data-emp-noμ—μ„ κ°€μ Έμ΄:', currentUser);
                  saveUserInfoToStorage(currentUser);
                  return;
                }
                
                // textContentμ—μ„ μ§μ›λ²νΈ μ¶”μ¶ μ‹λ„
                const textContent = parentUserInfo.textContent.trim();
                if (textContent && !textContent.includes('λ΅κ·ΈμΈμ΄ ν•„μ”ν•©λ‹λ‹¤')) {
                  const match = textContent.match(/([A-Za-z0-9]+)\s*λ‹/);
                  if (match) {
                    currentUser = match[1].toLowerCase();
                    console.log('β… parent window textContentμ—μ„ κ°€μ Έμ΄:', currentUser);
                    saveUserInfoToStorage(currentUser);
                    return;
                  }
                }
              }
            } catch (error) {
              // parent μ ‘κ·Ό λ¶κ°€ μ‹ λ‹¤μ λ°©λ²•μΌλ΅ μ§„ν–‰
            }
          }

          // λ°©λ²• 4: URL νλΌλ―Έν„°μ—μ„ κ°€μ Έμ¤κΈ°
          const urlParams = new URLSearchParams(window.location.search);
          const userParam = urlParams.get('user') || urlParams.get('userId') || urlParams.get('empNo');
          if (userParam) {
            currentUser = userParam.trim();
            console.log('β… URL νλΌλ―Έν„°μ—μ„ κ°€μ Έμ΄:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // λ°©λ²• 5: localStorageμ—μ„ κ°€μ Έμ¤κΈ° (fallback)
          const localUser = localStorage.getItem('userInfo') || localStorage.getItem('currentUser') || localStorage.getItem('empNo');
          if (localUser) {
            currentUser = localUser.trim();
            console.log('β… localStorageμ—μ„ κ°€μ Έμ΄:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // λ°©λ²• 6: postMessageλ΅ parentμ—κ² μ”μ²­
          if (window.parent && window.parent !== window) {
            return new Promise((resolve) => {
              const timeout = setTimeout(() => {
                currentUser = 'test001';
                console.log('β οΈ λ¨λ“  λ°©λ²• μ‹¤ν¨, κΈ°λ³Έκ°’ μ‚¬μ©:', currentUser);
                saveUserInfoToStorage(currentUser);
                resolve();
              }, 2000);

              window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'userInfo') {
                  clearTimeout(timeout);
                  currentUser = event.data.userId || event.data.empNo || event.data.user || 'test001';
                  console.log('β… postMessageλ΅ κ°€μ Έμ΄:', currentUser);
                  saveUserInfoToStorage(currentUser);
                  resolve();
                }
              }, { once: true });

              window.parent.postMessage({ type: 'requestUserInfo' }, '*');
            });
          }

          // λ¨λ“  λ°©λ²• μ‹¤ν¨ μ‹ κΈ°λ³Έκ°’
          currentUser = 'test001';
          console.log('β οΈ λ¨λ“  λ°©λ²• μ‹¤ν¨, κΈ°λ³Έκ°’ μ‚¬μ©:', currentUser);
          saveUserInfoToStorage(currentUser);

        } catch (error) {
          console.error('μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ° μ—λ¬:', error);
          currentUser = 'test001';
          saveUserInfoToStorage(currentUser);
        }
      }

      // νμ΄μ§€ λ΅λ“ μ‹ μ΄κΈ°ν™”
      document.addEventListener('DOMContentLoaded', async function() {
        // 1. μ§μ› μ •λ³΄ μΊμ‹ μ΄κΈ°ν™” (κ°€μ¥ λ¨Όμ €)
        await initializeEmployeesCache();
        
        // 2. parent pageμ—μ„ μ‚¬λ² κ°€μ Έμ¤κΈ°
        await getUserFromParent();

        // 3. URLμ—μ„ λ―Όκ°ν• μ •λ³΄ μ κ±° (λ³΄μ• κ°•ν™”)
        cleanUpURL();

        // 4. ν„μ¬ μ‚¬μ©μ μ •λ³΄ μ„¤μ •
        await loadUserInfo();
        
        // 5. λ‚ μ§ λ²”μ„ μ΄κΈ°ν™” λ° UI μ„¤μ •
        const dateRange = initializeDateRange();
        document.getElementById('searchStartDate').value = dateRange.startDate;
        document.getElementById('searchEndDate').value = dateRange.endDate;
        
        // 6. λ…ΈνΈ λ©λ΅ λ΅λ“
        await loadNotes();

        // 7. λ³΄μ• μ„¤μ • μ΄κΈ°ν™”
        setupSecurityCleanup();

        // μ΄κΈ° μ„¤μ •
        await initializeForm();

        // μ΄λ²¤νΈ λ¦¬μ¤λ„ λ“±λ΅
        setupEventListeners();
      });

      // μ΄κΈ° νΌ μ„¤μ •
      async function initializeForm() {
        // μ¤λ λ‚ μ§ μ„¤μ •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        // λ…ΈνΈλ²νΈ μλ™ μƒμ„±
        await updateNoteNumber();
        
        // μ‘μ„± λ¨λ“λ΅ μ„¤μ •
        setWriteMode();
      }

      // μ‘μ„± λ¨λ“ μ„¤μ •
      function setWriteMode() {
        isViewMode = false;
        isEditMode = false;
        selectedNoteId = null;
        
        // ν—¤λ” ν…μ¤νΈ λ³€κ²½
        document.querySelector('.form-header h3').textContent = 'λ…ΈνΈ μ‘μ„±';
        
        // λ²„νΌ μƒνƒ μ„¤μ •
        document.getElementById('saveMainBtn').disabled = false;
        document.getElementById('editMainBtn').disabled = true;
        document.getElementById('deleteMainBtn').disabled = true;
        
        // νΌ ν™μ„±ν™”
        setFormEnabled(true);
        
        // ν…μ΄λΈ” μ„ νƒ ν•΄μ 
        document.querySelectorAll('#notesTableBody tr').forEach(row => {
          row.classList.remove('selected');
        });
      }

      // μ΅°ν λ¨λ“ μ„¤μ •
      function setViewMode(note) {
        isViewMode = true;
        isEditMode = false;
        selectedNoteId = note.id;
        
        // ν—¤λ” ν…μ¤νΈ λ³€κ²½
        document.querySelector('.form-header h3').textContent = 'λ…ΈνΈ μ΅°ν';
        
        // νΌμ— λ°μ΄ν„° μ±„μ°κΈ°
        fillMainForm(note);
        
        // λ²„νΌ μƒνƒ μ„¤μ • (κ¶ν• ν™•μΈ)
        const canEdit = note.μ§μ›λ²νΈ === currentUser || currentUser === 'admin' || currentUser === 's25001';
        console.log('μ΅°ν λ¨λ“ - κ¶ν• ν™•μΈ:', {
          noteAuthor: note.μ§μ›λ²νΈ,
          currentUser: currentUser,
          canEdit: canEdit
        });
        
        document.getElementById('saveMainBtn').disabled = true;
        document.getElementById('editMainBtn').disabled = !canEdit;
        document.getElementById('deleteMainBtn').disabled = !canEdit;
        
        console.log('λ²„νΌ ν™μ„±ν™” μƒνƒ:', {
          saveBtn: !document.getElementById('saveMainBtn').disabled,
          editBtn: !document.getElementById('editMainBtn').disabled,
          deleteBtn: !document.getElementById('deleteMainBtn').disabled
        });
        
        // νΌ ν™μ„±ν™” (λ…ΈνΈλ²νΈ μ μ™Έ)
        setFormEnabled(true, true);
      }

      // μμ • λ¨λ“ μ„¤μ •
      function setEditMode() {
        isViewMode = false;
        isEditMode = true;
        
        // ν—¤λ” ν…μ¤νΈ λ³€κ²½
        document.querySelector('.form-header h3').textContent = 'λ…ΈνΈ μμ •';
        
        // λ²„νΌ μƒνƒ μ„¤μ •
        document.getElementById('saveMainBtn').disabled = false;
        document.getElementById('editMainBtn').disabled = true;
        document.getElementById('deleteMainBtn').disabled = true;
        
        // νΌ ν™μ„±ν™” (λ…ΈνΈλ²νΈλ” λΉ„ν™μ„±ν™” μ μ§€)
        setFormEnabled(true);
        document.getElementById('mainNumber').disabled = true;
      }

      // νΌ ν™μ„±ν™”/λΉ„ν™μ„±ν™”
      function setFormEnabled(enabled, readOnlyMode = false) {
        const formElements = document.querySelectorAll('#mainNoteForm input, #mainNoteForm textarea');
        formElements.forEach(element => {
          if (element.id === 'mainNumber') {
            // λ…ΈνΈλ²νΈλ” ν•­μƒ λΉ„ν™μ„±ν™”
            element.disabled = true;
          } else if (readOnlyMode) {
            // μ΅°ν λ¨λ“μ—μ„λ” λ…ΈνΈλ²νΈ μ μ™Έν•κ³  λ¨λ‘ ν™μ„±ν™”
            element.disabled = false;
          } else {
            // μΌλ° λ¨λ“
            element.disabled = !enabled;
          }
        });
        
        // λΌλ””μ¤ λ²„νΌλ“¤
        document.querySelectorAll('#mainNoteForm input[type="radio"]').forEach(radio => {
          if (readOnlyMode) {
            radio.disabled = false;
          } else {
            radio.disabled = !enabled;
          }
        });
        
        // νƒκ·Έ μμ‹ λ²„νΌλ“¤
        document.querySelectorAll('.tag-example-btn[data-target="mainTag"]').forEach(btn => {
          if (readOnlyMode) {
            btn.disabled = false;
          } else {
            btn.disabled = !enabled;
          }
        });
      }

      // λ‚ μ§ ν•μ‹ λ³€ν™ ν•¨μ (yyyymmdd β†’ yyyy-mm-dd)
      function formatDateForInput(dateString) {
        if (!dateString || dateString.length !== 8) return '';
        const year = dateString.substring(0, 4);
        const month = dateString.substring(4, 6);
        const day = dateString.substring(6, 8);
        return `${year}-${month}-${day}`;
      }

      // λ‚ μ§ ν•μ‹ λ³€ν™ ν•¨μ (yyyy-mm-dd β†’ yyyymmdd)
      function formatDateForStorage(dateString) {
        if (!dateString) return '';
        return dateString.replace(/-/g, '');
      }

      // λ©”μΈ νΌμ— λ°μ΄ν„° μ±„μ°κΈ°
      function fillMainForm(note) {
        // κµ¬λ¶„ λΌλ””μ¤ λ²„νΌ
        const categoryRadio = document.querySelector(`input[name="category"][value="${note.κµ¬λ¶„}"]`);
        if (categoryRadio) categoryRadio.checked = true;
        
        // λ‚ μ§ (yyyymmdd β†’ yyyy-mm-dd ν•μ‹μΌλ΅ λ³€ν™)
        const formattedDate = formatDateForInput(note.λ…ΈνΈλ‚ μ§ || '');
        document.getElementById('mainDate').value = formattedDate;
        
        // λ…ΈνΈλ²νΈ
        document.getElementById('mainNumber').value = note.λ…ΈνΈλ²νΈ || '';
        
        // νƒκ·Έ (μΉ© ν•νƒ)
        if (window.setTags_mainTag) {
          window.setTags_mainTag(note.νƒκ·Έ || '');
        }
        
        // λ‚΄μ©
        document.getElementById('mainContent').value = note.λ…ΈνΈλ‚΄μ© || '';
        
        // κ³µκ°μ—¬λ¶€ λΌλ””μ¤ λ²„νΌ
        const privacyRadio = document.querySelector(`input[name="privacy"][value="${note.κ³µκ°μ—¬λ¶€ || 'Y'}"]`);
        if (privacyRadio) privacyRadio.checked = true;
      }

      // λ©”μΈ νΌ μ΄κΈ°ν™”
      async function resetMainForm() {
        // νΌ λ¦¬μ…‹
        document.getElementById('mainNoteForm').reset();
        
        // κΈ°λ³Έκ°’ μ„¤μ •
        document.querySelector('input[name="category"][value="μ „μ²΄"]').checked = true;
        document.querySelector('input[name="privacy"][value="Y"]').checked = true;
        
        // μ¤λ λ‚ μ§ μ„¤μ •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        // νƒκ·Έ μ΄κΈ°ν™”
        if (window.setTags_mainTag) {
          window.setTags_mainTag('');
        }
        
        // λ…ΈνΈλ²νΈ μ¬μƒμ„±
        await updateNoteNumber();
        
        // μ‘μ„± λ¨λ“λ΅ μ „ν™
        setWriteMode();
      }

      // λ…ΈνΈλ²νΈ μ—…λ°μ΄νΈ
      async function updateNoteNumber() {
        const dateValue = document.getElementById('mainDate').value;
        if (dateValue && currentUser) {
          try {
            // yyyy-mm-dd β†’ yyyymmdd ν•μ‹μΌλ΅ λ³€ν™
            const formattedDate = formatDateForStorage(dateValue);
            const noteNumber = await generateNoteNumber(currentUser, formattedDate);
            document.getElementById('mainNumber').value = noteNumber;
          } catch (error) {
            console.error('λ…ΈνΈλ²νΈ μƒμ„± μ‹¤ν¨:', error);
          }
        }
      }

      // μ§μ› μ •λ³΄ λ΅λ“ (μΊμ‹ μ‚¬μ©)
      async function loadUserInfo() {
        try {
          console.log('=== μ§μ› μ •λ³΄ λ΅λ“ μ‹μ‘ ===');
          console.log('ν„μ¬ μ‚¬μ©μ:', currentUser);
          
          // μΊμ‹κ°€ λ΅λ”©λμ§€ μ•μ•λ‹¤λ©΄ λ¨Όμ € λ΅λ”©
          if (!employeesCacheLoaded) {
            console.log('μ§μ› μΊμ‹κ°€ λ΅λ”©λμ§€ μ•μ - μ΄κΈ°ν™” μ‹μ‘');
            await initializeEmployeesCache();
          }
          
          console.log('μ§μ› μΊμ‹ μƒνƒ:', employeesCacheLoaded);
          console.log('μΊμ‹λ μ§μ› μ:', employeesCache ? employeesCache.length : 0);
          
          if (employeesCache && employeesCache.length > 0) {
            console.log('μΊμ‹λ μ§μ› λ©λ΅ (μ²« 3λ…):', employeesCache.slice(0, 3));
            
            // ν„μ¬ μ‚¬μ©μμ™€ μ •ν™•ν μΌμΉν•λ” μ§μ› μ°ΎκΈ°
            const matchedEmployee = employeesCache.find(emp => {
              console.log(`λΉ„κµ: "${emp.μ§μ›λ²νΈ}" === "${currentUser}"`, emp.μ§μ›λ²νΈ === currentUser);
              return emp.μ§μ›λ²νΈ === currentUser;
            });
            
            console.log('λ§¤μΉ­λ μ§μ›:', matchedEmployee);
          }
          
          // μΊμ‹μ—μ„ μ§μ›λ… μ°ΎκΈ°
          currentUserName = getEmployeeNameFromCache(currentUser);
          console.log('μ΅°νλ μ§μ›λ…:', currentUserName);
          
          if (currentUserName === currentUser) {
            currentUserName = 'μ• μ μ—†μ';
            console.log('μ§μ›λ…μ„ μ°Ύμ§€ λ»ν•¨ - "μ• μ μ—†μ"μΌλ΅ μ„¤μ •');
          }

          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
          
          console.log('=== μ§μ› μ •λ³΄ λ΅λ“ μ™„λ£ ===');
        } catch (error) {
          console.error('μ§μ› μ •λ³΄ λ΅λ“ μ‹¤ν¨:', error);
          currentUserName = 'μ• μ μ—†μ';
          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
        }
      }

                         // λ…ΈνΈ λ©λ΅ λ΅λ“ (λ‚ μ§ λ²”μ„ κΈ°λ°)
      async function loadNotes() {
        try {
          console.log('=== λ…ΈνΈ λ©λ΅ λ΅λ“ μ‹μ‘ ===');
          
          // λ‚ μ§ λ²”μ„κ°€ μ„¤μ •λμ§€ μ•μ•μΌλ©΄ μ΄κΈ°ν™”
          if (!currentDateRange.startDate || !currentDateRange.endDate) {
            initializeDateRange();
          }
          
          console.log('λ‚ μ§ λ²”μ„:', currentDateRange);
          console.log('ν„μ¬ μ‚¬μ©μ:', currentUser);
          
          // μ„λ²„μ—μ„ λ‚ μ§ λ²”μ„μ™€ κ¶ν• κΈ°λ°μΌλ΅ λ°μ΄ν„° μ΅°ν
          cachedNotes = await getNoteshareDataByDateRange(
            currentUser, 
            currentDateRange.startDate, 
            currentDateRange.endDate
          );
          
          console.log('μ„λ²„μ—μ„ μ΅°νλ λ…ΈνΈ μ:', cachedNotes.length);
          
          // ν„μ¬ κ³µκ°μ—¬λ¶€ ν•„ν„° μ μ©
          const privacyFilter = document.querySelector('input[name="privacyFilter"]:checked')?.value || 'public';
          const filteredNotes = applyPrivacyFilter(cachedNotes, privacyFilter);
          
          notes = filteredNotes;
          displayNotes(notes);
          
          console.log('=== λ…ΈνΈ λ©λ΅ λ΅λ“ μ™„λ£ ===');
        } catch (error) {
          console.error('λ…ΈνΈ λ΅λ“ μ‹¤ν¨:', error);
          alert('λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ”λ° μ‹¤ν¨ν–μµλ‹λ‹¤.');
        }
      }

      // κ³µκ°μ—¬λ¶€ ν•„ν„° μ μ©
      function applyPrivacyFilter(notesList, privacyFilter) {
        if (privacyFilter === 'public') {
          return notesList.filter(note => note.κ³µκ°μ—¬λ¶€ === 'Y');
        } else {
          // μ „μ²΄ λ³΄κΈ°: μ΄λ―Έ μ„λ²„μ—μ„ κ¶ν• κΈ°λ°μΌλ΅ ν•„ν„°λ§λ¨
          return notesList;
        }
      }

      // ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“ ν•„ν„°λ§ (νƒκ·Έ, λ‚΄μ©, μ§μ›λ…)
      function applyClientSideFilters(notesList, filters) {
        let filtered = [...notesList];
        
        // νƒκ·Έ ν•„ν„°
        if (filters.tag && filters.tag.trim()) {
          const tagKeyword = filters.tag.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.νƒκ·Έ && note.νƒκ·Έ.toLowerCase().includes(tagKeyword)
          );
        }
        
        // λ…ΈνΈλ‚΄μ© ν•„ν„°
        if (filters.content && filters.content.trim()) {
          const contentKeyword = filters.content.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.λ…ΈνΈλ‚΄μ© && note.λ…ΈνΈλ‚΄μ©.toLowerCase().includes(contentKeyword)
          );
        }
        
        // μ§μ›λ… ν•„ν„°
        if (filters.author && filters.author.trim()) {
          const authorKeyword = filters.author.trim().toLowerCase();
          filtered = filtered.filter(note => {
            // DBμ— μ €μ¥λ μ§μ›λ…μ΄ μμΌλ©΄ μ‚¬μ©, μ—†μΌλ©΄ μΊμ‹μ—μ„ μ°ΎκΈ°
            let authorName = note.μ§μ›λ…;
            if (!authorName || authorName === note.μ§μ›λ²νΈ) {
              authorName = getEmployeeNameFromCache(note.μ§μ›λ²νΈ);
            }
            return authorName && authorName.toLowerCase().includes(authorKeyword);
          });
        }
        
        return filtered;
      }

      // λ‚ μ§ λ²”μ„κ°€ λ³€κ²½λμ—λ”μ§€ ν™•μΈ
      function hasDateRangeChanged(newStartDate, newEndDate) {
        return currentDateRange.startDate !== newStartDate || 
               currentDateRange.endDate !== newEndDate;
      }

      // URLμ—μ„ λ―Όκ°ν• νλΌλ―Έν„° μ κ±° (λ³΄μ• κ°•ν™”)
      function cleanUpURL() {
        try {
          const url = new URL(window.location);
          const urlParams = new URLSearchParams(url.search);
          
          // μ§μ›λ²νΈ κ΄€λ ¨ λ―Όκ°ν• νλΌλ―Έν„°λ“¤ μ κ±°
          const sensitiveParams = ['empNo', 'userId', 'user', 'employeeId', 'emp_no'];
          let hasChanges = false;
          
          sensitiveParams.forEach(param => {
            if (urlParams.has(param)) {
              urlParams.delete(param);
              hasChanges = true;
            }
          });
          
          // λ³€κ²½μ‚¬ν•­μ΄ μμ„ λ•λ§ URL μ—…λ°μ΄νΈ
          if (hasChanges) {
            const cleanSearch = urlParams.toString();
            const cleanUrl = cleanSearch ? `${url.pathname}?${cleanSearch}` : url.pathname;
            
            // λΈλΌμ°μ € νμ¤ν† λ¦¬μ—μ„ λ―Όκ°ν• μ •λ³΄ μ κ±° (λ’¤λ΅κ°€κΈ° λ°©μ§€)
            window.history.replaceState({}, document.title, cleanUrl);
            
            console.log('π”’ λ³΄μ•: URLμ—μ„ λ―Όκ°ν• μ •λ³΄ μ κ±°λ¨');
            console.log('μ •λ¦¬ μ „:', url.href);
            console.log('μ •λ¦¬ ν›„:', window.location.href);
          }
        } catch (error) {
          console.error('URL μ •λ¦¬ μ¤‘ μ¤λ¥:', error);
        }
      }

      // μ¶”κ°€ λ³΄μ•: νμ΄μ§€ μ΄νƒ μ‹ λ―Όκ°ν• λ°μ΄ν„° μ •λ¦¬ (μ„ νƒμ )
      function setupSecurityCleanup() {
        // νμ΄μ§€ μ΄νƒ μ‹ μµμ… (μ£Όμ„ μ²λ¦¬λ¨ - μƒλ΅κ³ μΉ¨ μ‹ λ΅κ·ΈμΈ μ μ§€λ¥Ό μ„ν•΄)
        window.addEventListener('beforeunload', function() {
          // μ™„μ „ λ΅κ·Έμ•„μ›ƒ μ‹μ—λ§ μ •λ¦¬ν•λ„λ΅ μ„ νƒμ  μ‚¬μ©
          // clearUserInfoFromStorage();
        });
        
        // λΈλΌμ°μ € νƒ­ λΉ„ν™μ„±ν™” μ‹ μ¶”κ°€ λ³΄μ• (μ„ νƒμ )
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            console.log('π”’ νƒ­ λΉ„ν™μ„±ν™” - λ³΄μ• λ¨λ“');
            // ν•„μ”μ‹ μ—¬κΈ°μ„ μ¶”κ°€ λ³΄μ• μ΅°μΉ
          }
        });

        // λ΅κ·Έμ•„μ›ƒ λ²„νΌμ΄ μλ‹¤λ©΄ μ΄λ²¤νΈ λ¦¬μ¤λ„ μ¶”κ°€
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            clearUserInfoFromStorage();
            console.log('π λ΅κ·Έμ•„μ›ƒ - μ €μ¥λ μ •λ³΄ μ •λ¦¬');
          });
        }
      }

      // λ…ΈνΈλ²νΈμ—μ„ λ§μ§€λ§‰ λ²νΈλ§ μ¶”μ¶
      function extractNoteSequence(noteNumber) {
        if (!noteNumber) return '-';
        const parts = noteNumber.split('-');
        return parts.length > 0 ? parts[parts.length - 1] : '-';
      }

      // λ…ΈνΈ λ©λ΅ ν‘μ‹
      function displayNotes(notesToDisplay) {
        const tbody = document.getElementById('notesTableBody');
        tbody.innerHTML = '';

        // κΈ°λ³Έ μ •λ ¬: λ…ΈνΈλ‚ μ§ λ‚΄λ¦Όμ°¨μ, μ§μ›λ… μ¤λ¦„μ°¨μ, λ²νΈ μ¤λ¦„μ°¨μ
        const sortedNotes = [...notesToDisplay].sort((a, b) => {
          // 1μμ„: λ…ΈνΈλ‚ μ§ λ‚΄λ¦Όμ°¨μ
          const dateA = a.λ…ΈνΈλ‚ μ§ || '';
          const dateB = b.λ…ΈνΈλ‚ μ§ || '';
          if (dateA !== dateB) {
            return dateB.localeCompare(dateA); // λ‚΄λ¦Όμ°¨μ
          }
          
          // 2μμ„: μ§μ›λ… μ¤λ¦„μ°¨μ
          const nameA = a.μ§μ›λ… || getEmployeeNameFromCache(a.μ§μ›λ²νΈ) || a.μ§μ›λ²νΈ || '';
          const nameB = b.μ§μ›λ… || getEmployeeNameFromCache(b.μ§μ›λ²νΈ) || b.μ§μ›λ²νΈ || '';
          if (nameA !== nameB) {
            return nameA.localeCompare(nameB); // μ¤λ¦„μ°¨μ
          }
          
          // 3μμ„: λ…ΈνΈλ²νΈ μ¤λ¦„μ°¨μ
          const numberA = a.λ…ΈνΈλ²νΈ || '';
          const numberB = b.λ…ΈνΈλ²νΈ || '';
          return numberA.localeCompare(numberB); // μ¤λ¦„μ°¨μ
        });

        sortedNotes.forEach(note => {
          const row = document.createElement('tr');
          row.setAttribute('data-note-id', note.id);
          
          // λ‚ μ§ ν•μ‹ λ³€ν™ (yyyymmdd β†’ yyyy-mm-dd)
          const displayDate = formatDateForInput(note.λ…ΈνΈλ‚ μ§ || '');
          
          // μ§μ›λ… μ²λ¦¬: μ €μ¥λ μ§μ›λ…μ΄ μ—†κ±°λ‚ μ§μ›λ²νΈμ™€ κ°™μΌλ©΄ μΊμ‹μ—μ„ μ°ΎκΈ°
          let authorName = note.μ§μ›λ…;
          if (!authorName || authorName === note.μ§μ›λ²νΈ) {
            authorName = getEmployeeNameFromCache(note.μ§μ›λ²νΈ);
          }
          
          row.innerHTML = `
            <td class="col-category">${note.κµ¬λ¶„ || '-'}</td>
            <td class="col-date">${displayDate || '-'}</td>
            <td class="col-author">${authorName || note.μ§μ›λ²νΈ || '-'}</td>
            <td class="col-number">${extractNoteSequence(note.λ…ΈνΈλ²νΈ)}</td>
            <td class="col-tag">${note.νƒκ·Έ || '-'}</td>
            <td class="col-content">${note.λ…ΈνΈλ‚΄μ© || ''}</td>
            <td class="col-privacy">${note.κ³µκ°μ—¬λ¶€ || 'Y'}</td>
          `;
          
          // λ”λΈ”ν΄λ¦­ μ΄λ²¤νΈ (μ΅°ν λ¨λ“)
          row.addEventListener('dblclick', () => {
            selectNoteForView(note, row);
          });
          
          tbody.appendChild(row);
        });
      }

      // λ…ΈνΈ μ΅°ν λ¨λ“λ΅ μ„ νƒ
      function selectNoteForView(note, row) {
        // ν…μ΄λΈ” ν–‰ μ„ νƒ ν‘μ‹
        document.querySelectorAll('#notesTableBody tr').forEach(r => {
          r.classList.remove('selected');
        });
        row.classList.add('selected');

        // μ΅°ν λ¨λ“λ΅ μ „ν™
        setViewMode(note);
      }

      // ν…μ΄λΈ” μ •λ ¬ ν•¨μ
      function sortTable(column) {
        // ν„μ¬ μ •λ ¬ μƒνƒ μ—…λ°μ΄νΈ
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        // μ •λ ¬ ν™”μ‚΄ν‘ μ—…λ°μ΄νΈ
        updateSortArrows();

        // ν„μ¬ ν‘μ‹λ λ…ΈνΈλ“¤μ„ μ •λ ¬ν•μ—¬ λ‹¤μ‹ ν‘μ‹
        const currentNotes = getCurrentDisplayedNotes();
        const sortedNotes = sortNotes(currentNotes, column, currentSort.direction);
        displaySortedNotes(sortedNotes);
      }

      // λ…ΈνΈ λ°°μ—΄ μ •λ ¬
      function sortNotes(notes, column, direction) {
        return [...notes].sort((a, b) => {
          let valueA, valueB;

          switch (column) {
            case 'κµ¬λ¶„':
              valueA = a.κµ¬λ¶„ || '';
              valueB = b.κµ¬λ¶„ || '';
              break;
            case 'λ…ΈνΈλ‚ μ§':
              valueA = a.λ…ΈνΈλ‚ μ§ || '';
              valueB = b.λ…ΈνΈλ‚ μ§ || '';
              break;
            case 'μ§μ›λ…':
              valueA = a.μ§μ›λ… || getEmployeeNameFromCache(a.μ§μ›λ²νΈ) || a.μ§μ›λ²νΈ || '';
              valueB = b.μ§μ›λ… || getEmployeeNameFromCache(b.μ§μ›λ²νΈ) || b.μ§μ›λ²νΈ || '';
              break;
            case 'λ…ΈνΈλ²νΈ':
              valueA = a.λ…ΈνΈλ²νΈ || '';
              valueB = b.λ…ΈνΈλ²νΈ || '';
              break;
            case 'νƒκ·Έ':
              valueA = a.νƒκ·Έ || '';
              valueB = b.νƒκ·Έ || '';
              break;
            case 'λ…ΈνΈλ‚΄μ©':
              valueA = a.λ…ΈνΈλ‚΄μ© || '';
              valueB = b.λ…ΈνΈλ‚΄μ© || '';
              break;
            case 'κ³µκ°μ—¬λ¶€':
              valueA = a.κ³µκ°μ—¬λ¶€ || '';
              valueB = b.κ³µκ°μ—¬λ¶€ || '';
              break;
            default:
              valueA = '';
              valueB = '';
          }

          const result = valueA.localeCompare(valueB);
          return direction === 'desc' ? -result : result;
        });
      }

      // μ •λ ¬ ν™”μ‚΄ν‘ μ—…λ°μ΄νΈ
      function updateSortArrows() {
        // λ¨λ“  ν™”μ‚΄ν‘ μ΄κΈ°ν™”
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
          arrow.textContent = '';
          arrow.className = 'sort-arrow';
        });

        // ν„μ¬ μ •λ ¬ μ»¬λΌμ ν™”μ‚΄ν‘ μ„¤μ •
        if (currentSort.column) {
          const currentHeader = document.querySelector(`th[data-column="${currentSort.column}"] .sort-arrow`);
          if (currentHeader) {
            currentHeader.textContent = currentSort.direction === 'asc' ? ' β†‘' : ' β†“';
            currentHeader.className = `sort-arrow ${currentSort.direction}`;
          }
        }
      }

      // ν„μ¬ ν‘μ‹λ λ…ΈνΈλ“¤ κ°€μ Έμ¤κΈ°
      function getCurrentDisplayedNotes() {
        const tbody = document.getElementById('notesTableBody');
        const rows = tbody.querySelectorAll('tr');
        const notes = [];
        
        rows.forEach(row => {
          const noteId = row.getAttribute('data-note-id');
          const note = cachedNotes.find(n => n.id === noteId);
          if (note) {
            notes.push(note);
          }
        });
        
        return notes;
      }

      // μ •λ ¬λ λ…ΈνΈλ“¤μ„ ν…μ΄λΈ”μ— ν‘μ‹ (κΈ°λ³Έ μ •λ ¬ μ μ©ν•μ§€ μ•μ)
      function displaySortedNotes(notesToDisplay) {
        const tbody = document.getElementById('notesTableBody');
        tbody.innerHTML = '';

        notesToDisplay.forEach(note => {
          const row = document.createElement('tr');
          row.setAttribute('data-note-id', note.id);
          
          // λ‚ μ§ ν•μ‹ λ³€ν™ (yyyymmdd β†’ yyyy-mm-dd)
          const displayDate = formatDateForInput(note.λ…ΈνΈλ‚ μ§ || '');
          
          // μ§μ›λ… μ²λ¦¬: μ €μ¥λ μ§μ›λ…μ΄ μ—†κ±°λ‚ μ§μ›λ²νΈμ™€ κ°™μΌλ©΄ μΊμ‹μ—μ„ μ°ΎκΈ°
          let authorName = note.μ§μ›λ…;
          if (!authorName || authorName === note.μ§μ›λ²νΈ) {
            authorName = getEmployeeNameFromCache(note.μ§μ›λ²νΈ);
          }
          
          row.innerHTML = `
            <td class="col-category">${note.κµ¬λ¶„ || '-'}</td>
            <td class="col-date">${displayDate || '-'}</td>
            <td class="col-author">${authorName || note.μ§μ›λ²νΈ || '-'}</td>
            <td class="col-number">${extractNoteSequence(note.λ…ΈνΈλ²νΈ)}</td>
            <td class="col-tag">${note.νƒκ·Έ || '-'}</td>
            <td class="col-content content-preview">${note.λ…ΈνΈλ‚΄μ© || '-'}</td>
            <td class="col-privacy">${note.κ³µκ°μ—¬λ¶€ || '-'}</td>
          `;

          // λ”λΈ”ν΄λ¦­ μ΄λ²¤νΈ μ¶”κ°€
          row.addEventListener('dblclick', () => loadNoteToForm(note));
          
          tbody.appendChild(row);
        });
      }

      // μ΄λ²¤νΈ λ¦¬μ¤λ„ μ„¤μ •
      function setupEventListeners() {
         // κ²€μƒ‰ κΈ°λ¥
         document.getElementById('searchBtn').addEventListener('click', performSearch);
         document.getElementById('resetBtn').addEventListener('click', resetSearch);
         
         // κ²€μƒ‰ μ…λ ¥ ν•„λ“λ“¤μ Enter ν‚¤ μ΄λ²¤νΈ
         ['searchDate', 'searchTag', 'searchContent', 'searchAuthor'].forEach(id => {
           const element = document.getElementById(id);
           if (element) {
             element.addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                 performSearch();
               }
             });
           }
         });

                 // κ³µκ°μ—¬λ¶€ ν•„ν„° λ³€κ²½ μ‹ μλ™ κ²€μƒ‰
        document.querySelectorAll('input[name="privacyFilter"]').forEach(radio => {
          radio.addEventListener('change', performSearch);
        });

        // ν…μ΄λΈ” ν—¤λ” ν΄λ¦­ μ •λ ¬
        document.querySelectorAll('th.sortable').forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortTable(column);
          });
        });

        // λ©”μΈ νΌ λ²„νΌ μ΄λ²¤νΈ
        document.getElementById('saveMainBtn').addEventListener('click', saveMainNote);
        document.getElementById('editMainBtn').addEventListener('click', () => setEditMode());
        document.getElementById('deleteMainBtn').addEventListener('click', deleteMainNote);
        document.getElementById('resetMainBtn').addEventListener('click', resetMainForm);

        // λ‚ μ§ λ³€κ²½ μ‹ λ…ΈνΈλ²νΈ μ—…λ°μ΄νΈ
        document.getElementById('mainDate').addEventListener('change', updateNoteNumber);

        // νƒκ·Έ μ…λ ¥ μ΄λ²¤νΈ
        setupTagInput('mainTag', 'mainTagChips', 'mainTagHidden');

        // λ¨λ‹¬ μ΄λ²¤νΈ (κΈ°μ΅΄ λ¨λ‹¬μ€ μ μ§€)
        document.getElementById('saveBtn').addEventListener('click', saveNote);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.querySelector('.close').addEventListener('click', closeModal);

        // νƒκ·Έ μμ‹ λ²„νΌ μ΄λ²¤νΈ (λ¨λ“  νƒκ·Έ λ²„νΌ)
        document.querySelectorAll('.tag-example-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const target = this.dataset.target || 'modalTag';
            addTagFromExample(this.dataset.tag, target);
          });
        });

        // λ¨λ‹¬ μ™Έλ¶€ ν΄λ¦­μ‹ λ‹«κΈ°
        window.addEventListener('click', function(event) {
          const modal = document.getElementById('noteModal');
          if (event.target === modal) {
            closeModal();
          }
        });
      }

             // κ²€μƒ‰ μν–‰
             async function performSearch() {
        const startDate = document.getElementById('searchStartDate').value;
        const endDate = document.getElementById('searchEndDate').value;
        const tag = document.getElementById('searchTag').value.trim();
        const content = document.getElementById('searchContent').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const privacyFilter = document.querySelector('input[name="privacyFilter"]:checked').value;

        try {
          // λ‚ μ§ λ²”μ„κ°€ λ³€κ²½λ κ²½μ° μ„λ²„μ—μ„ μƒλ΅ μ΅°ν
          if (hasDateRangeChanged(startDate, endDate)) {
            console.log('λ‚ μ§ λ²”μ„ λ³€κ²½λ¨ - μ„λ²„μ—μ„ μƒλ΅ μ΅°ν');
            
            // λ‚ μ§ λ²”μ„ μ—…λ°μ΄νΈ
            currentDateRange.startDate = startDate;
            currentDateRange.endDate = endDate;
            
            // μ„λ²„μ—μ„ μƒλ΅μ΄ λ°μ΄ν„° μ΅°ν
            cachedNotes = await getNoteshareDataByDateRange(currentUser, startDate, endDate);
            console.log('μƒλ΅ μ΅°νλ λ…ΈνΈ μ:', cachedNotes.length);
          }
          
          // κ³µκ°μ—¬λ¶€ ν•„ν„° μ μ©
          let filteredNotes = applyPrivacyFilter(cachedNotes, privacyFilter);
          
          // ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“ ν•„ν„° μ μ© (νƒκ·Έ, λ‚΄μ©, μ§μ›λ…)
          const clientFilters = { tag, content, author };
          filteredNotes = applyClientSideFilters(filteredNotes, clientFilters);
          
          console.log('μµμΆ… ν•„ν„°λ§λ λ…ΈνΈ μ:', filteredNotes.length);
          
          notes = filteredNotes;
          displayNotes(notes);
          
        } catch (error) {
          console.error('κ²€μƒ‰ μ‹¤ν¨:', error);
          alert('κ²€μƒ‰μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
        }
      }

       // κ²€μƒ‰ μ΄κΈ°ν™”
       function resetSearch() {
         // λ‚ μ§ λ²”μ„λ¥Ό κΈ°λ³Έκ°’(30μΌ μ „~μ¤λ)μΌλ΅ μ¬μ„¤μ •
         const dateRange = initializeDateRange();
         document.getElementById('searchStartDate').value = dateRange.startDate;
         document.getElementById('searchEndDate').value = dateRange.endDate;
         
         // κΈ°νƒ€ κ²€μƒ‰ μ΅°κ±΄ μ΄κΈ°ν™”
         document.getElementById('searchTag').value = '';
         document.getElementById('searchContent').value = '';
         document.getElementById('searchAuthor').value = '';
         
         // κΈ°λ³Έ ν•„ν„° μ„¤μ •
         document.querySelector('input[name="privacyFilter"][value="public"]').checked = true;
         
         // λ…ΈνΈ λ©λ΅ λ‹¤μ‹ λ΅λ“
         loadNotes();
       }

      // λ¨λ‹¬ μ—΄κΈ°
      function openModal(editMode) {
        isEditMode = editMode;
        const modal = document.getElementById('noteModal');
        const modalTitle = document.getElementById('modalTitle');
        const privacyGroup = document.getElementById('privacyGroup');

        if (editMode) {
          if (!selectedNoteId) {
            alert('μμ •ν•  λ…ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.');
            return;
          }
          modalTitle.textContent = 'λ…ΈνΈ μμ •';
          fillFormWithSelectedNote();
        } else {
          modalTitle.textContent = 'λ…ΈνΈ μ…λ ¥';
          clearForm();
          // μ¤λ λ‚ μ§ κΈ°λ³Έκ°’ μ„¤μ •
          document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
        }

        // κ³µκ°μ—¬λ¶€ ν•„λ“λ” κ¶ν•μ΄ μλ” μ‚¬μ©μλ§ ν‘μ‹
        if (hasPrivacyEditPermission(currentUser, editMode ? getSelectedNote()?.μ§μ›λ²νΈ : currentUser)) {
          privacyGroup.style.display = 'block';
        } else {
          privacyGroup.style.display = 'none';
        }

        modal.style.display = 'block';
      }

      // μ„ νƒλ λ…ΈνΈ μ •λ³΄λ΅ νΌ μ±„μ°κΈ°
      function fillFormWithSelectedNote() {
        const note = getSelectedNote();
        if (!note) return;

        // κµ¬λ¶„ λΌλ””μ¤ λ²„νΌ
        const categoryRadio = document.querySelector(`input[name="modalCategory"][value="${note.κµ¬λ¶„ || 'μ „μ²΄'}"]`);
        if (categoryRadio) categoryRadio.checked = true;

        document.getElementById('modalDate').value = note.λ…ΈνΈλ‚ μ§ || '';
        document.getElementById('modalNumber').value = note.λ…ΈνΈλ²νΈ || '';
        document.getElementById('modalTag').value = note.νƒκ·Έ || '';
        document.getElementById('modalContent').value = note.λ…ΈνΈλ‚΄μ© || '';
        
        // κ³µκ°μ—¬λ¶€ λΌλ””μ¤ λ²„νΌ
        const privacyRadio = document.querySelector(`input[name="modalPrivacy"][value="${note.κ³µκ°μ—¬λ¶€ || 'Y'}"]`);
        if (privacyRadio) privacyRadio.checked = true;
      }

      // ν„μ¬ μ„ νƒλ λ…ΈνΈ κ°€μ Έμ¤κΈ°
      function getSelectedNote() {
        return notes.find(note => note.id === selectedNoteId);
      }

      // νΌ μ΄κΈ°ν™”
      function clearForm() {
        document.getElementById('noteForm').reset();
        // κΈ°λ³Έκ°’ μ„¤μ •
        document.querySelector('input[name="modalCategory"][value="μ „μ²΄"]').checked = true;
        document.querySelector('input[name="modalPrivacy"][value="Y"]').checked = true;
      }

      // λ¨λ‹¬ λ‹«κΈ°
      function closeModal() {
        document.getElementById('noteModal').style.display = 'none';
        clearForm();
      }

      // λ…ΈνΈ μ €μ¥
      async function saveNote() {
        const form = document.getElementById('noteForm');
        if (!form.checkValidity()) {
          alert('λ¨λ“  ν•„μ ν•­λ©μ„ μ…λ ¥ν•μ„Έμ”.');
          return;
        }

        const noteData = {
          μ§μ›λ²νΈ: currentUser,
          μ§μ›λ…: currentUserName,
          κµ¬λ¶„: document.querySelector('input[name="modalCategory"]:checked').value,
          λ…ΈνΈλ‚ μ§: document.getElementById('modalDate').value,
          λ…ΈνΈλ²νΈ: document.getElementById('modalNumber').value,
          νƒκ·Έ: document.getElementById('modalTag').value,
          λ…ΈνΈλ‚΄μ©: document.getElementById('modalContent').value,
          κ³µκ°μ—¬λ¶€: document.querySelector('input[name="modalPrivacy"]:checked').value
        };

        try {
          let result;
          if (isEditMode) {
            result = await updateNote(selectedNoteId, noteData);
          } else {
            result = await addNote(noteData);
          }

          if (result.success) {
            alert(isEditMode ? 'λ…ΈνΈκ°€ μμ •λμ—μµλ‹λ‹¤.' : 'λ…ΈνΈκ°€ μ €μ¥λμ—μµλ‹λ‹¤.');
            closeModal();
            await loadNotes();
          } else {
            alert('μ €μ¥μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + (result.error?.message || 'μ• μ μ—†λ” μ¤λ¥'));
          }
        } catch (error) {
          console.error('μ €μ¥ μ‹¤ν¨:', error);
          alert('μ €μ¥ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
        }
      }

      // μ„ νƒλ λ…ΈνΈ μ‚­μ 
      async function deleteSelectedNote() {
        if (!selectedNoteId) {
          alert('μ‚­μ ν•  λ…ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.');
          return;
        }

        if (!confirm('μ •λ§λ΅ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
          return;
        }

        try {
          const result = await deleteNote(selectedNoteId);
          if (result.success) {
            alert('λ…ΈνΈκ°€ μ‚­μ λμ—μµλ‹λ‹¤.');
            selectedNoteId = null;
            // μ°μΈ΅ ν¨λ„ μ΄κΈ°ν™”
            document.getElementById('detailCategory').textContent = '-';
            document.getElementById('detailDate').textContent = '-';
            document.getElementById('detailNumber').textContent = '-';
            document.getElementById('detailTag').textContent = '-';
            document.getElementById('contentDisplay').textContent = 'λ…ΈνΈλ¥Ό μ„ νƒν•λ©΄ λ‚΄μ©μ΄ ν‘μ‹λ©λ‹λ‹¤.';
            document.getElementById('editBtn').disabled = true;
            document.getElementById('deleteBtn').disabled = true;
            
            await loadNotes();
          } else {
            alert('μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + (result.error?.message || 'μ• μ μ—†λ” μ¤λ¥'));
          }
        } catch (error) {
          console.error('μ‚­μ  μ‹¤ν¨:', error);
          alert('μ‚­μ  μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
        }
      }

      // λ©”μΈ νΌ μ €μ¥
      async function saveMainNote() {
        const form = document.getElementById('mainNoteForm');
        if (!form.checkValidity()) {
          alert('λ¨λ“  ν•„μ ν•­λ©μ„ μ…λ ¥ν•μ„Έμ”.');
          return;
        }

        const noteData = {
          μ§μ›λ²νΈ: currentUser,
          μ§μ›λ…: currentUserName,
          κµ¬λ¶„: document.querySelector('input[name="category"]:checked').value,
          λ…ΈνΈλ‚ μ§: formatDateForStorage(document.getElementById('mainDate').value),
          λ…ΈνΈλ²νΈ: document.getElementById('mainNumber').value,
          νƒκ·Έ: window.getTags_mainTag ? window.getTags_mainTag() : '',
          λ…ΈνΈλ‚΄μ©: document.getElementById('mainContent').value,
          κ³µκ°μ—¬λ¶€: document.querySelector('input[name="privacy"]:checked').value
        };

        try {
          let result;
          if (isEditMode && selectedNoteId) {
            result = await updateNote(selectedNoteId, noteData);
          } else {
            result = await addNote(noteData);
          }

          if (result.success) {
            alert(isEditMode ? 'λ…ΈνΈκ°€ μμ •λμ—μµλ‹λ‹¤.' : 'λ…ΈνΈκ°€ μ €μ¥λμ—μµλ‹λ‹¤.');
            await loadNotes();
            if (!isEditMode) {
              await resetMainForm(); // μƒ μ‘μ„± μ‹μ—λ§ μ΄κΈ°ν™”
            }
          } else {
            alert('μ €μ¥μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + (result.error?.message || 'μ• μ μ—†λ” μ¤λ¥'));
          }
        } catch (error) {
          console.error('μ €μ¥ μ‹¤ν¨:', error);
          alert('μ €μ¥ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
        }
      }

      // λ©”μΈ νΌ μ‚­μ 
      async function deleteMainNote() {
        if (!selectedNoteId) {
          alert('μ‚­μ ν•  λ…ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.');
          return;
        }

        if (!confirm('μ •λ§λ΅ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
          return;
        }

        try {
          const result = await deleteNote(selectedNoteId);
          if (result.success) {
            alert('λ…ΈνΈκ°€ μ‚­μ λμ—μµλ‹λ‹¤.');
            await loadNotes();
            await resetMainForm(); // μ‘μ„± λ¨λ“λ΅ λ³µκ·€
          } else {
            alert('μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤: ' + (result.error?.message || 'μ• μ μ—†λ” μ¤λ¥'));
          }
        } catch (error) {
          console.error('μ‚­μ  μ‹¤ν¨:', error);
          alert('μ‚­μ  μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
        }
      }

      // νƒκ·Έ μ…λ ¥ μ„¤μ •
      function setupTagInput(inputId, chipsId, hiddenId) {
        const input = document.getElementById(inputId);
        const chipsContainer = document.getElementById(chipsId);
        const hiddenInput = document.getElementById(hiddenId);
        
        if (!input || !chipsContainer || !hiddenInput) return;

        let tags = [];

        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTagChip(input.value.trim());
          } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
            removeTagChip(tags.length - 1);
          }
        });

        input.addEventListener('blur', function() {
          if (input.value.trim()) {
            addTagChip(input.value.trim());
          }
        });

        function addTagChip(tagText) {
          if (!tagText || tags.includes(tagText)) return;

          tags.push(tagText);
          input.value = '';
          updateChipsDisplay();
          updateHiddenInput();
        }

        function removeTagChip(index) {
          tags.splice(index, 1);
          updateChipsDisplay();
          updateHiddenInput();
        }

        function updateChipsDisplay() {
          chipsContainer.innerHTML = '';
          if (tags.length > 0) {
            tags.forEach((tag, index) => {
              const chip = document.createElement('div');
              chip.className = 'tag-chip';
              chip.innerHTML = `
                <span>${tag}</span>
                <button type="button" class="tag-remove" onclick="removeTagByIndex(${index}, '${inputId}')">&times;</button>
              `;
              chipsContainer.appendChild(chip);
            });
            chipsContainer.style.display = 'flex';
          } else {
            chipsContainer.style.display = 'none';
          }
        }

        function updateHiddenInput() {
          hiddenInput.value = tags.join(', ');
        }

        // μ „μ—­ ν•¨μλ΅ νƒκ·Έ μ κ±° κΈ°λ¥ λ…Έμ¶
        window[`removeTagByIndex_${inputId}`] = removeTagChip;
        window.removeTagByIndex = function(index, targetInputId) {
          if (targetInputId === inputId) {
            removeTagChip(index);
          }
        };

        // νƒκ·Έ μ„¤μ • ν•¨μ
        window[`setTags_${inputId}`] = function(tagString) {
          tags = tagString ? tagString.split(',').map(t => t.trim()).filter(t => t) : [];
          updateChipsDisplay();
          updateHiddenInput();
        };

        // νƒκ·Έ κ°€μ Έμ¤κΈ° ν•¨μ
        window[`getTags_${inputId}`] = function() {
          return tags.join(', ');
        };

        // μ΄κΈ°ν™”
        updateChipsDisplay();
      }

      // νƒκ·Έ μμ‹μ—μ„ νƒκ·Έ μ¶”κ°€
      function addTagFromExample(tag, targetId = 'modalTag') {
        if (targetId === 'mainTag') {
          // μΉ© ν•νƒ νƒκ·Έ μ¶”κ°€
          const input = document.getElementById(targetId);
          input.value = tag;
          const event = new KeyboardEvent('keydown', { key: 'Enter' });
          input.dispatchEvent(event);
        } else {
          // κΈ°μ΅΄ λ°©μ‹ (λ¨λ‹¬)
          const tagInput = document.getElementById(targetId);
          const currentTags = tagInput.value.trim();
          
          const tagArray = currentTags ? currentTags.split(',').map(t => t.trim()) : [];
          
          if (!tagArray.includes(tag)) {
            const newValue = currentTags ? currentTags + ', ' + tag : tag;
            tagInput.value = newValue;
          }
          
          tagInput.focus();
        }
      }
    </script>
  </body>
</html>
