<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

         <title>ìš°ë¦¬ì§‘ ë…¸íŠ¸</title>
     <link rel="icon" href="data:,">
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
     <link rel="stylesheet" href="./styles.css" />
    
    <!-- Supabase JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ -->

    <script src="./supabase.js"></script>
    
    
  </head>
  <body>
    <div class="container">

      <!-- í—¤ë” ë¶€ë¶„: ì§ì›ë²ˆí˜¸ì™€ ì§ì›ëª… í‘œì‹œ -->
      <div class="header" id="headerSection">
        <div class="header-left">
          <div class="title">ìš°ë¦¬ì§‘ ë…¸íŠ¸</div>
          <button id="mobileVersionBtn" class="mobile-btn" onclick="window.location.href='index_m.html'" title="ëª¨ë°”ì¼ ë²„ì „ìœ¼ë¡œ ì´ë™">
            Mobile
          </button>
        </div>
        <div class="user-info">
          <span id="userEmployeeNumber">-</span> | <span id="userEmployeeName">-</span>
        </div>
      </div>


      <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
      <div class="main-content">
        <!-- ì¢Œì¸¡ ì„¹ì…˜: ë…¸íŠ¸ ëª©ë¡ ë° ê²€ìƒ‰ -->
        <div class="left-section">
                     <!-- ê²€ìƒ‰ ì˜ì—­ -->
           <div class="search-section">
             <div class="search-controls">
               <!-- ì²« ë²ˆì§¸ ì¤„: ë‚ ì§œ ë²”ìœ„ -->
               <div class="search-row">
                 <div class="search-field">
                   <label>ì‹œì‘ì¼:</label>
                   <input type="date" id="searchStartDate" placeholder="ì‹œì‘ì¼ ì„ íƒ">
                 </div>
                 <div class="search-field">
                   <label>ì¢…ë£Œì¼:</label>
                   <input type="date" id="searchEndDate" placeholder="ì¢…ë£Œì¼ ì„ íƒ">
      </div>
    </div>


               <!-- ë‘ ë²ˆì§¸ ì¤„ -->
               <div class="search-row">
                 <div class="search-field">
                   <label>íƒœê·¸:</label>
                   <input type="text" id="searchTag" placeholder="íƒœê·¸ ê²€ìƒ‰">
                 </div>
                 <div class="search-field">
                   <label>ë…¸íŠ¸ë‚´ìš©:</label>
                   <input type="text" id="searchContent" placeholder="ë‚´ìš© ê²€ìƒ‰">
                 </div>
               </div>
               
               <!-- ì„¸ ë²ˆì§¸ ì¤„: ì§ì›ëª… ê²€ìƒ‰ + ê²Œì‹œì—¬ë¶€ í•„í„° -->
               <div class="search-row">
                 <div class="search-field">
                   <label>ì§ì›ëª…:</label>
                   <input type="text" id="searchAuthor" placeholder="ì§ì›ëª… ê²€ìƒ‰">
                 </div>
                                 <div class="publish-filter">
                  <label>ë³´ê¸°:</label>
                  <div class="radio-group">
                    <label class="radio-label">
                      <input type="radio" name="publishFilter" value="published" checked>
                      <span>ê²Œì‹œë§Œ</span>
                    </label>
                    <label class="radio-label">
                      <input type="radio" name="publishFilter" value="all">
                      <span>ì „ì²´</span>
                    </label>
                  </div>
                </div>
               </div>
               
               <!-- ë„¤ ë²ˆì§¸ ì¤„: ê²€ìƒ‰ ë²„íŠ¼ -->
               <div class="search-row">
                 <div class="search-buttons">
                   <button id="searchBtn">ê²€ìƒ‰</button>
                   <button id="resetBtn">ì´ˆê¸°í™”</button>
                 </div>
               </div>
             </div>
           </div>

          <!-- ë…¸íŠ¸ ëª©ë¡ í…Œì´ë¸” -->
          <div class="table-section">
            <table id="notesTable">
              <thead>
                <tr>
                  <th class="col-category sortable" data-column="êµ¬ë¶„">êµ¬ë¶„ <span class="sort-arrow"></span></th>
                  <th class="col-date sortable" data-column="ë…¸íŠ¸ë‚ ì§œ">ë…¸íŠ¸ë‚ ì§œ <span class="sort-arrow"></span></th>
                  <th class="col-author sortable" data-column="ì§ì›ëª…">ì§ì›ëª… <span class="sort-arrow"></span></th>
                  <th class="col-number sortable" data-column="ë…¸íŠ¸ë²ˆí˜¸">ë²ˆí˜¸ <span class="sort-arrow"></span></th>
                  <th class="col-tag sortable" data-column="íƒœê·¸">íƒœê·¸ <span class="sort-arrow"></span></th>
                  <th class="col-content sortable" data-column="ë…¸íŠ¸ë‚´ìš©">ë…¸íŠ¸ë‚´ìš© <span class="sort-arrow"></span></th>
                  <th class="col-publish sortable" data-column="ê²Œì‹œì—¬ë¶€">ê²Œì‹œ <span class="sort-arrow"></span></th>
                </tr>
              </thead>
              <tbody id="notesTableBody">
                <!-- ë™ì ìœ¼ë¡œ ë…¸íŠ¸ ëª©ë¡ì´ ë“¤ì–´ê°ˆ ê³³ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- ìš°ì¸¡ ì„¹ì…˜: ë…¸íŠ¸ ì‘ì„± ë° í¸ì§‘ -->
        <div class="right-section">
          <!-- ë…¸íŠ¸ ì‘ì„± í¼ -->
          <div class="write-form">
            <div class="form-header">
              <h3>ë…¸íŠ¸ ì‘ì„±</h3>
            </div>
            
            <form id="mainNoteForm" class="main-form">
              <div class="form-group inline-group">
                <label>êµ¬ë¶„:</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="category" value="ì„¼í„°ì¥" checked>
                    <span>ì„¼í„°ì¥</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="category" value="ê°œì¸">
                    <span>ê°œì¸</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="category" value="ì „ì²´">
                    <span>ì „ì²´</span>
                  </label>
                </div>
              </div>

              <div class="form-group form-row">
                <div class="form-col inline-group">
                  <label for="mainDate">ë…¸íŠ¸ë‚ ì§œ:</label>
                  <input type="date" id="mainDate" required>
                </div>
                <div class="form-col inline-group">
                  <label for="mainNumber">ë…¸íŠ¸ë²ˆí˜¸:</label>
                  <input type="text" id="mainNumber" readonly>
                </div>
              </div>

              <div class="form-group">
                <div class="tag-input-wrapper">
                  <div class="tag-input-row">
                    <label for="mainTag">íƒœê·¸:</label>
                    <input type="text" id="mainTag" class="tag-input-field" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”">
                    <input type="hidden" id="mainTagHidden">
                  </div>
                  <div class="tag-chips" id="mainTagChips"></div>
                </div>
                <div class="tag-examples">
                  <span class="tag-label">ì˜ˆì‹œ íƒœê·¸:</span>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ìƒë‹´">íšŒì›ìƒë‹´</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="ë³´í˜¸ììš”ì²­">ë³´í˜¸ììš”ì²­</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ìš”ì²­">íšŒì›ìš”ì²­</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ì´ìŠˆ">íšŒì›ì´ìŠˆ</button>
                  <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="ì¤€ë¹„ì‚¬í•­">ì¤€ë¹„ì‚¬í•­</button>
                </div>
              </div>

              <div class="form-group textarea-container">
                <label for="mainContent">ë…¸íŠ¸ë‚´ìš©:</label>
                <textarea id="mainContent" rows="8" required placeholder="ë…¸íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
              </div>
            </form>

            <!-- ê²Œì‹œì—¬ë¶€ ë³„ë„ ì»¨í…Œì´ë„ˆ -->
            <div class="publish-container">
              <div class="form-group inline-group">
                <label>ê²Œì‹œì—¬ë¶€:</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="publish" value="Y" checked>
                    <span>Y</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="publish" value="N">
                    <span>N</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div class="button-section">
              <button id="resetMainBtn" class="action-btn reset-btn">ì´ˆê¸°í™”</button>
              <button id="saveMainBtn" class="action-btn save-btn">ì €ì¥</button>
              <button id="editMainBtn" class="action-btn edit-btn" disabled>ìˆ˜ì •</button>
              <button id="deleteMainBtn" class="action-btn delete-btn" disabled>ì‚­ì œ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ Alert ëª¨ë‹¬ -->
    <div id="customAlertModal" class="custom-modal">
      <div class="custom-modal-content alert-modal">
        <div class="custom-modal-header">
          <h3>ì•Œë¦¼</h3>
        </div>
        <div class="custom-modal-body">
          <p id="alertMessage"></p>
        </div>
        <div class="custom-modal-footer">
          <button type="button" id="alertOkBtn" class="custom-btn primary-btn">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ Confirm ëª¨ë‹¬ -->
    <div id="customConfirmModal" class="custom-modal">
      <div class="custom-modal-content confirm-modal">
        <div class="custom-modal-header">
          <h3>í™•ì¸</h3>
        </div>
        <div class="custom-modal-body">
          <p id="confirmMessage"></p>
        </div>
        <div class="custom-modal-footer">
          <button type="button" id="confirmCancelBtn" class="custom-btn secondary-btn">ì·¨ì†Œ</button>
          <button type="button" id="confirmOkBtn" class="custom-btn primary-btn">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ userInfo ìš”ì†Œ (parent pageì—ì„œ ì‚¬ë²ˆ ê°€ì ¸ì˜¤ê¸°ìš©) -->
    <div id="userInfo" style="display: none;"></div>
    

    
    <!-- Parent í˜ì´ì§€ìš© í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ (Parent í˜ì´ì§€ì—ì„œ ì´ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”) -->
    <!--
    <script>
      // Parent í˜ì´ì§€ì—ì„œ ë…¸íŠ¸ ì•±ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì „ë‹¬í•˜ëŠ” ë°©ë²•ë“¤:
      
      // ë°©ë²• 1: userInfo ìš”ì†Œì— ì§ì›ë²ˆí˜¸ ì„¤ì • (ê°€ì¥ ê°„ë‹¨)
      function setUserInfoForNoteApp(empNo) {
        const userInfoElement = document.getElementById('userInfo');
        if (userInfoElement) {
          userInfoElement.textContent = empNo;
          console.log('userInfo ìš”ì†Œì— ì§ì›ë²ˆí˜¸ ì„¤ì •:', empNo);
        }
      }
      
      // ë°©ë²• 2: sessionStorageì— ì €ì¥
      function setUserToSession(empNo) {
        sessionStorage.setItem('currentUser', empNo);
        console.log('sessionStorageì— ì§ì›ë²ˆí˜¸ ì €ì¥:', empNo);
      }
      
      // ë°©ë²• 3: postMessage ì‘ë‹µ ë¦¬ìŠ¤ë„ˆ
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'requestUserInfo') {
          const currentUserEmpNo = getCurrentUserEmpNo(); // ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
          event.source.postMessage({
            type: 'userInfo',
            userId: currentUserEmpNo,
            empNo: currentUserEmpNo
          }, '*');
          console.log('postMessageë¡œ ì§ì›ë²ˆí˜¸ ì „ì†¡:', currentUserEmpNo);
        }
      });
      
      // ë°©ë²• 4: URL íŒŒë¼ë¯¸í„°ë¡œ ë…¸íŠ¸ ì•± ì—´ê¸°
      function openNoteAppWithUser(empNo) {
        const noteAppUrl = './note_app.html?empNo=' + encodeURIComponent(empNo);
        // iframeì´ë‚˜ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
        window.open(noteAppUrl, '_blank');
      }
      
      // ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ì‹¤ì œ êµ¬í˜„ í•„ìš”)
      function getCurrentUserEmpNo() {
        // ì—¬ê¸°ì„œ ì‹¤ì œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì§ì›ë²ˆí˜¸ë¥¼ ë°˜í™˜
        // ì˜ˆ: return document.getElementById('loginUserId').value;
        // ì˜ˆ: return window.currentUser;
        // ì˜ˆ: return sessionStorage.getItem('userEmpNo');
        return 'USER_EMP_NO_HERE'; // ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”
      }
    </script>
    -->

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let currentUser = '';
      let currentUserName = '';
      let selectedNoteId = null;
      let notes = [];
      let isEditMode = false;
      let isViewMode = false;
      
      // ì§ì› ì •ë³´ ìºì‹œ
      let employeesCache = null;
      let employeesCacheLoaded = false;
      
      // í…Œì´ë¸” ì •ë ¬ ìƒíƒœ
      let currentSort = {
        column: null,
        direction: 'asc' // 'asc' ë˜ëŠ” 'desc'
      };
      
      // ë‚ ì§œ í•„í„° ê´€ë ¨ ë³€ìˆ˜
      let cachedNotes = []; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì›ë³¸ ë°ì´í„°
      let currentDateRange = { startDate: '', endDate: '' }; // í˜„ì¬ ì„¤ì •ëœ ë‚ ì§œ ë²”ìœ„

      // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
      function getKoreaDate() {
        const now = new Date();
        const koreaOffset = 9 * 60; // UTC+9 (ë¶„ ë‹¨ìœ„)
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const koreaTime = new Date(utc + (koreaOffset * 60000));
        return koreaTime;
      }

      function getKoreaDateString(date = null) {
        const koreaDate = date || getKoreaDate();
        return koreaDate.toISOString().split('T')[0]; // yyyy-mm-dd í˜•ì‹
      }

      function getKoreaDateStringForDB(date = null) {
        const dateStr = getKoreaDateString(date);
        return dateStr.replace(/-/g, ''); // yyyymmdd í˜•ì‹
      }

      function getDateDaysAgo(days) {
        const koreaDate = getKoreaDate();
        koreaDate.setDate(koreaDate.getDate() - days);
        return koreaDate;
      }

      function initializeDateRange() {
        const today = getKoreaDateString();
        const twoWeeksAgo = getKoreaDateString(getDateDaysAgo(14));
        
        currentDateRange.startDate = twoWeeksAgo;
        currentDateRange.endDate = today;
        
        return { startDate: twoWeeksAgo, endDate: today };
      }

      // ì§ì› ì •ë³´ ì´ˆê¸°í™” ë° ìºì‹±
      async function initializeEmployeesCache() {
        if (employeesCacheLoaded) {
          return employeesCache;
        }
        
        try {
          console.log('ì§ì› ì •ë³´ ë¡œë”© ì¤‘...');
          employeesCache = await getEmployeesInfo();
          employeesCacheLoaded = true;
          console.log('ì§ì› ì •ë³´ ë¡œë”© ì™„ë£Œ:', employeesCache.length, 'ëª…');
          
          // ë””ë²„ê¹…: ì²« ë²ˆì§¸ ì§ì› ì •ë³´ í™•ì¸
          if (employeesCache.length > 0) {
            console.log('ì²« ë²ˆì§¸ ì§ì› ì •ë³´:', employeesCache[0]);
            console.log('ì§ì›ë²ˆí˜¸ í•„ë“œëª… í™•ì¸:', Object.keys(employeesCache[0]));
          }
          
          return employeesCache;
        } catch (error) {
          console.error('ì§ì› ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
          employeesCache = [];
          employeesCacheLoaded = true;
          return employeesCache;
        }
      }

      // ìºì‹œëœ ì§ì› ì •ë³´ì—ì„œ ì§ì›ëª… ì°¾ê¸°
      function getEmployeeNameFromCache(employeeNumber) {
        if (!employeesCacheLoaded || !employeesCache) {
          console.log('ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•ŠìŒ:', { employeesCacheLoaded, employeesCache });
          return employeeNumber; // ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì§ì›ë²ˆí˜¸ ë°˜í™˜
        }
        
        console.log('ì§ì›ë²ˆí˜¸ë¡œ ê²€ìƒ‰:', employeeNumber);
        console.log('ìºì‹œì—ì„œ ê²€ìƒ‰ ì¤‘...');
        
        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
        let employee = employeesCache.find(emp => emp.ì§ì›ë²ˆí˜¸ === employeeNumber);
        
        // ì •í™•í•œ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ì‹œë„
        if (!employee) {
          console.log('ì •í™•í•œ ë§¤ì¹­ ì‹¤íŒ¨ - ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ì¬ì‹œë„');
          employee = employeesCache.find(emp => 
            emp.ì§ì›ë²ˆí˜¸ && emp.ì§ì›ë²ˆí˜¸.toLowerCase() === employeeNumber.toLowerCase()
          );
        }
        
        // ê³µë°± ì œê±° í›„ ì‹œë„
        if (!employee) {
          console.log('ëŒ€ì†Œë¬¸ì ë§¤ì¹­ ì‹¤íŒ¨ - ê³µë°± ì œê±° í›„ ì¬ì‹œë„');
          const trimmedNumber = employeeNumber.trim();
          employee = employeesCache.find(emp => 
            emp.ì§ì›ë²ˆí˜¸ && emp.ì§ì›ë²ˆí˜¸.trim() === trimmedNumber
          );
        }
        
        console.log('ìµœì¢… ë§¤ì¹­ ê²°ê³¼:', employee);
        return employee ? employee.ì§ì›ëª… : employeeNumber;
      }

      // ì „ì²´ ì§ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìºì‹œì—ì„œ)
      function getAllEmployeesFromCache() {
        if (!employeesCacheLoaded || !employeesCache) {
          return [];
        }
        return employeesCache;
      }

      // ì§ì› ì •ë³´ ìºì‹œ ìƒˆë¡œê³ ì¹¨
      async function refreshEmployeesCache() {
        employeesCacheLoaded = false;
        employeesCache = null;
        return await initializeEmployeesCache();
      }

      // ë””ë²„ê¹…ìš© ì „ì—­ í•¨ìˆ˜ë“¤
      window.debugEmployeeCache = function() {
        console.log('=== ì§ì› ìºì‹œ ë””ë²„ê¹… ===');
        console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
        console.log('ìºì‹œ ë¡œë”© ìƒíƒœ:', employeesCacheLoaded);
        console.log('ìºì‹œëœ ì§ì› ìˆ˜:', employeesCache ? employeesCache.length : 0);
        
        if (employeesCache && employeesCache.length > 0) {
          console.log('ì „ì²´ ì§ì› ëª©ë¡:', employeesCache);
          
          // í˜„ì¬ ì‚¬ìš©ì ê²€ìƒ‰
          const found = employeesCache.find(emp => emp.ì§ì›ë²ˆí˜¸ === currentUser);
          console.log('í˜„ì¬ ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼:', found);
          
          // s25001 ê²€ìƒ‰
          const s25001 = employeesCache.find(emp => emp.ì§ì›ë²ˆí˜¸ === 's25001');
          console.log('s25001 ê²€ìƒ‰ ê²°ê³¼:', s25001);
        }
        
        return {
          currentUser,
          employeesCacheLoaded,
          employeesCount: employeesCache ? employeesCache.length : 0,
          employeesCache
        };
      };

      // ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥ì†Œì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
      function saveUserInfoToStorage(userInfo) {
        if (userInfo && userInfo.trim()) {
          try {
            // sessionStorageì— ì—¬ëŸ¬ í‚¤ë¡œ ì €ì¥ (í˜¸í™˜ì„±)
            sessionStorage.setItem('currentUser', userInfo.trim());
            sessionStorage.setItem('userInfo', userInfo.trim());
            sessionStorage.setItem('empNo', userInfo.trim());
            
            // localStorageì—ë„ ë°±ì—… ì €ì¥
            localStorage.setItem('currentUser', userInfo.trim());
            localStorage.setItem('userInfo', userInfo.trim());
            localStorage.setItem('empNo', userInfo.trim());
            
            console.log('ğŸ’¾ ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì™„ë£Œ:', userInfo.trim());
          } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì—ëŸ¬:', error);
          }
        }
      }

      // ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ í•¨ìˆ˜
      function clearUserInfoFromStorage() {
        try {
          // sessionStorage ì •ë¦¬
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('userInfo');
          sessionStorage.removeItem('empNo');
          
          // localStorage ì •ë¦¬
          localStorage.removeItem('currentUser');
          localStorage.removeItem('userInfo');
          localStorage.removeItem('empNo');
          
          console.log('ğŸ—‘ï¸ ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ ì™„ë£Œ');
        } catch (error) {
          console.error('ì‚¬ìš©ì ì •ë³´ ì‚­ì œ ì—ëŸ¬:', error);
        }
      }

      // ì§ì› ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
      function isValidEmployee(employeeNumber) {
        if (!employeeNumber) {
          console.log('âŒ ì§ì›ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return false;
        }

        // ìºì‹œê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ false
        if (!employeesCacheLoaded || !employeesCache) {
          console.log('âŒ ì§ì› ì •ë³´ ìºì‹œê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return false;
        }

        // adminê³¼ s25001ì€ í•­ìƒ ìœ íš¨
        if (employeeNumber === 'admin' || employeeNumber === 's25001') {
          console.log('âœ… ê´€ë¦¬ì ê³„ì •:', employeeNumber);
          return true;
        }

        // ì§ì›ëª…ë‹¨ì—ì„œ ì°¾ê¸°
        const employee = employeesCache.find(emp => 
          emp.ì§ì›ë²ˆí˜¸ && emp.ì§ì›ë²ˆí˜¸.toLowerCase() === employeeNumber.toLowerCase()
        );

        if (employee) {
          console.log('âœ… ìœ íš¨í•œ ì§ì›:', employeeNumber, 'â†’', employee.ì§ì›ëª…);
          return true;
        } else {
          console.log('âŒ ì§ì›ëª…ë‹¨ì— ì—†ëŠ” ì§ì›ë²ˆí˜¸:', employeeNumber);
          return false;
        }
      }

      // parent pageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
      async function getUserFromParent() {
        try {
          // ë°©ë²• 0: ì´ë¯¸ currentUserê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì¬ì‚¬ìš©
          if (currentUser && currentUser.trim()) {
            console.log('ğŸ”„ ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ì¬ì‚¬ìš©:', currentUser);
            return;
          }

          // ë°©ë²• 1: sessionStorageì—ì„œ ë¨¼ì € í™•ì¸ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘)
          const sessionUser = sessionStorage.getItem('currentUser') || 
                             sessionStorage.getItem('userInfo') || 
                             sessionStorage.getItem('empNo');
          if (sessionUser && sessionUser.trim()) {
            currentUser = sessionUser.trim();
            console.log('âœ… sessionStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ë³µì›:', currentUser);
            // sessionStorageì— ì €ì¥ëœ ì •ë³´ë¥¼ ë‹¤ì‹œ ì €ì¥í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€
            saveUserInfoToStorage(currentUser);
            return;
          }

          // ë°©ë²• 2: í˜„ì¬ í˜ì´ì§€ì˜ userInfo ìš”ì†Œì—ì„œ ê°€ì ¸ì˜¤ê¸°
          const userInfoElement = document.getElementById('userInfo');
          if (userInfoElement && userInfoElement.textContent.trim()) {
            currentUser = userInfoElement.textContent.trim();
            console.log('âœ… í˜„ì¬ í˜ì´ì§€ userInfoì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // ë°©ë²• 3: parent windowì—ì„œ ì§ì ‘ ì ‘ê·¼
          if (window.parent && window.parent !== window) {
            try {
              const parentUserInfo = window.parent.document.getElementById('userInfo');
              if (parentUserInfo) {
                // data-emp-no ì†ì„±ì—ì„œ ë¨¼ì € ì‹œë„
                const empNoFromData = parentUserInfo.getAttribute('data-emp-no');
                if (empNoFromData && empNoFromData.trim()) {
                  currentUser = empNoFromData.trim();
                  console.log('âœ… parent window data-emp-noì—ì„œ ê°€ì ¸ì˜´:', currentUser);
                  saveUserInfoToStorage(currentUser);
                  return;
                }
                
                // textContentì—ì„œ ì§ì›ë²ˆí˜¸ ì¶”ì¶œ ì‹œë„
                const textContent = parentUserInfo.textContent.trim();
                if (textContent && !textContent.includes('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')) {
                  const match = textContent.match(/([A-Za-z0-9]+)\s*ë‹˜/);
                  if (match) {
                    currentUser = match[1].toLowerCase();
                    console.log('âœ… parent window textContentì—ì„œ ê°€ì ¸ì˜´:', currentUser);
                    saveUserInfoToStorage(currentUser);
                    return;
                  }
                }
              }
            } catch (error) {
              // parent ì ‘ê·¼ ë¶ˆê°€ ì‹œ ë‹¤ìŒ ë°©ë²•ìœ¼ë¡œ ì§„í–‰
            }
          }

          // ë°©ë²• 4: URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸°
          const urlParams = new URLSearchParams(window.location.search);
          const userParam = urlParams.get('user') || urlParams.get('userId') || urlParams.get('empNo');
          if (userParam) {
            currentUser = userParam.trim();
            console.log('âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // ë°©ë²• 5: localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸° (fallback)
          const localUser = localStorage.getItem('userInfo') || localStorage.getItem('currentUser') || localStorage.getItem('empNo');
          if (localUser) {
            currentUser = localUser.trim();
            console.log('âœ… localStorageì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // ë°©ë²• 6: postMessageë¡œ parentì—ê²Œ ìš”ì²­
          if (window.parent && window.parent !== window) {
            return new Promise((resolve) => {
              const timeout = setTimeout(() => {
                currentUser = 'test001';
                console.log('âš ï¸ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', currentUser);
                saveUserInfoToStorage(currentUser);
                resolve();
              }, 2000);

              window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'userInfo') {
                  clearTimeout(timeout);
                  currentUser = event.data.userId || event.data.empNo || event.data.user || 'test001';
                  console.log('âœ… postMessageë¡œ ê°€ì ¸ì˜´:', currentUser);
                  saveUserInfoToStorage(currentUser);
                  resolve();
                }
              }, { once: true });

              window.parent.postMessage({ type: 'requestUserInfo' }, '*');
            });
          }

          // ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
          currentUser = 'test001';
          console.log('âš ï¸ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', currentUser);
          saveUserInfoToStorage(currentUser);

        } catch (error) {
          console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬:', error);
          currentUser = 'test001';
          saveUserInfoToStorage(currentUser);
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', async function() {
        // 1. ì§ì› ì •ë³´ ìºì‹œ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì €)
        await initializeEmployeesCache();
        
        // 2. parent pageì—ì„œ ì‚¬ë²ˆ ê°€ì ¸ì˜¤ê¸°
        await getUserFromParent();

        // 3. URLì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±° (ë³´ì•ˆ ê°•í™”)
        cleanUpURL();

        // 4. í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
        await loadUserInfo();
        
        // 5. ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™” ë° UI ì„¤ì •
        const dateRange = initializeDateRange();
        document.getElementById('searchStartDate').value = dateRange.startDate;
        document.getElementById('searchEndDate').value = dateRange.endDate;
        
        // 6. ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ
        await loadNotes();

        // 7. ë³´ì•ˆ ì„¤ì • ì´ˆê¸°í™”
        setupSecurityCleanup();

        // ì´ˆê¸° ì„¤ì •
        await initializeForm();

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        setupEventListeners();
      });

      // ì´ˆê¸° í¼ ì„¤ì •
      async function initializeForm() {
        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        // ë…¸íŠ¸ë²ˆí˜¸ ìë™ ìƒì„±
        await updateNoteNumber();
        
        // ì‘ì„± ëª¨ë“œë¡œ ì„¤ì •
        setWriteMode();
      }

      // ì‘ì„± ëª¨ë“œ ì„¤ì •
      function setWriteMode() {
        isViewMode = false;
        isEditMode = false;
        selectedNoteId = null;
        
        // í—¤ë” í…ìŠ¤íŠ¸ ë³€ê²½
        document.querySelector('.form-header h3').textContent = 'ë…¸íŠ¸ ì‘ì„±';
        
        // ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        document.getElementById('saveMainBtn').disabled = false;
        document.getElementById('editMainBtn').disabled = true;
        document.getElementById('deleteMainBtn').disabled = true;
        
        // í¼ í™œì„±í™”
        setFormEnabled(true);
        
        // í…Œì´ë¸” ì„ íƒ í•´ì œ
        document.querySelectorAll('#notesTableBody tr').forEach(row => {
          row.classList.remove('selected');
        });
      }

      // ì¡°íšŒ ëª¨ë“œ ì„¤ì •
      function setViewMode(note) {
        isViewMode = true;
        isEditMode = false;
        selectedNoteId = note.id;
        
        // í—¤ë” í…ìŠ¤íŠ¸ ë³€ê²½
        document.querySelector('.form-header h3').textContent = 'ë…¸íŠ¸ ì¡°íšŒ';
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        fillMainForm(note);
        
        // ë²„íŠ¼ ìƒíƒœ ì„¤ì • (ê¶Œí•œ í™•ì¸)
        const canEdit = note.ì§ì›ë²ˆí˜¸ === currentUser || currentUser === 'admin' || currentUser === 's25001';
        console.log('ì¡°íšŒ ëª¨ë“œ - ê¶Œí•œ í™•ì¸:', {
          noteAuthor: note.ì§ì›ë²ˆí˜¸,
          currentUser: currentUser,
          canEdit: canEdit
        });
        
        document.getElementById('saveMainBtn').disabled = true;
        document.getElementById('editMainBtn').disabled = !canEdit;
        document.getElementById('deleteMainBtn').disabled = !canEdit;
        
        console.log('ë²„íŠ¼ í™œì„±í™” ìƒíƒœ:', {
          saveBtn: !document.getElementById('saveMainBtn').disabled,
          editBtn: !document.getElementById('editMainBtn').disabled,
          deleteBtn: !document.getElementById('deleteMainBtn').disabled
        });
        
        // í¼ í™œì„±í™” (ë…¸íŠ¸ë²ˆí˜¸ ì œì™¸)
        setFormEnabled(true, true);
      }

      // ìˆ˜ì • ê¶Œí•œ í™•ì¸
      function canEditNote() {
        if (!selectedNoteId) {
          return false;
        }
        
        // í˜„ì¬ ì„ íƒëœ ë…¸íŠ¸ì˜ ì •ë³´ë¥¼ ì°¾ê¸°
        const selectedNote = cachedNotes.find(note => note.id === selectedNoteId);
        if (!selectedNote) {
          console.error('ì„ íƒëœ ë…¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', selectedNoteId);
          return false;
        }
        
        // ê¶Œí•œ í™•ì¸: ì‘ì„±ì, admin, s25001ë§Œ ìˆ˜ì • ê°€ëŠ¥
        const canEdit = selectedNote.ì§ì›ë²ˆí˜¸ === currentUser || 
                       currentUser === 'admin' || 
                       currentUser === 's25001';
        
        // ê¶Œí•œ í™•ì¸ ë¡œê·¸
        console.log('ìˆ˜ì • ê¶Œí•œ:', canEdit ? 'í—ˆìš©' : 'ê±°ë¶€');
        
        return canEdit;
      }

      // ì§ì ‘ ìˆ˜ì • ì‹¤í–‰
      async function executeDirectEdit() {
        console.log('ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ - ì§ì ‘ ìˆ˜ì • ì‹¤í–‰');
        
        try {
          // ì„ íƒëœ ë…¸íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (!selectedNoteId) {
            await customAlert('ìˆ˜ì •í•  ë…¸íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }
          
          // ê¶Œí•œ í™•ì¸
          if (!canEditNote()) {
            await customAlert('ì´ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // í™•ì¸ ëŒ€í™”ìƒì
          const confirmed = await customConfirm('í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ìœ¼ë¡œ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (!confirmed) {
            return;
          }

          // í¼ ìœ íš¨ì„± ê²€ì‚¬
          const form = document.getElementById('mainNoteForm');
          if (!form.checkValidity()) {
            await customAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }

          // ë…¸íŠ¸ ë°ì´í„° ìˆ˜ì§‘
          const noteData = {
            ì§ì›ë²ˆí˜¸: currentUser,
            ì§ì›ëª…: currentUserName,
            êµ¬ë¶„: document.querySelector('input[name="category"]:checked').value,
            ë…¸íŠ¸ë‚ ì§œ: formatDateForStorage(document.getElementById('mainDate').value),
            ë…¸íŠ¸ë²ˆí˜¸: document.getElementById('mainNumber').value,
            íƒœê·¸: window.getTags_mainTag ? window.getTags_mainTag() : '',
            ë…¸íŠ¸ë‚´ìš©: document.getElementById('mainContent').value,
            ê²Œì‹œì—¬ë¶€: document.querySelector('input[name="publish"]:checked').value
          };

          console.log('ğŸ”„ ìˆ˜ì • ë°ì´í„°:', noteData);

          // ìˆ˜ì • ì‹¤í–‰
          const result = await executeNoteUpdate(selectedNoteId, noteData);
          
          // ê²°ê³¼ ì²˜ë¦¬
          if (result.success) {
            await customAlert('ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadNotes();
            
            // ìˆ˜ì •ëœ ë…¸íŠ¸ë¡œ ì¡°íšŒ ëª¨ë“œ ì „í™˜
            if (result.data && result.data.id) {
              const newNote = result.data;
              selectedNoteId = newNote.id;
              setViewMode(newNote);
              selectTableRow(newNote.id);
            }
          } else {
            const errorMessage = result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            await customAlert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
          }

        } catch (error) {
          console.error('ğŸ’¥ ìˆ˜ì • ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
          await customAlert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ìˆ˜ì • ëª¨ë“œ ì„¤ì • (ê¸°ì¡´ í•¨ìˆ˜ëŠ” ìœ ì§€)
      function setEditMode() {
        // ì„ íƒëœ ë…¸íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (!selectedNoteId) {
          alert('ìˆ˜ì •í•  ë…¸íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ê¶Œí•œ í™•ì¸
        if (!canEditNote()) {
          alert('ì´ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
        isViewMode = false;
        isEditMode = true;
        
        console.log('ğŸ”§ ìˆ˜ì • ëª¨ë“œ ì§„ì…:', selectedNoteId);
        
        // UI ì—…ë°ì´íŠ¸
        document.querySelector('.form-header h3').textContent = 'ë…¸íŠ¸ ìˆ˜ì •';
        
        // ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        document.getElementById('saveMainBtn').disabled = false;
        document.getElementById('editMainBtn').disabled = true;
        document.getElementById('deleteMainBtn').disabled = true;
        document.getElementById('resetMainBtn').disabled = false;
        
        // í¼ í™œì„±í™” (ë…¸íŠ¸ë²ˆí˜¸ëŠ” í•­ìƒ ë¹„í™œì„±í™”)
        setFormEnabled(true);
        document.getElementById('mainNumber').disabled = true;
        
        console.log('ğŸ“ ìˆ˜ì • ëª¨ë“œ í™œì„±í™” ì™„ë£Œ');
      }

      // í¼ í™œì„±í™”/ë¹„í™œì„±í™”
      function setFormEnabled(enabled, readOnlyMode = false) {
        const formElements = document.querySelectorAll('#mainNoteForm input, #mainNoteForm textarea');
        formElements.forEach(element => {
          if (element.id === 'mainNumber') {
            // ë…¸íŠ¸ë²ˆí˜¸ëŠ” í•­ìƒ ë¹„í™œì„±í™”
            element.disabled = true;
          } else if (readOnlyMode) {
            // ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ë…¸íŠ¸ë²ˆí˜¸ ì œì™¸í•˜ê³  ëª¨ë‘ í™œì„±í™”
            element.disabled = false;
          } else {
            // ì¼ë°˜ ëª¨ë“œ
            element.disabled = !enabled;
          }
        });
        
        // ë¼ë””ì˜¤ ë²„íŠ¼ë“¤ (í¼ ë‚´ë¶€)
        document.querySelectorAll('#mainNoteForm input[type="radio"]').forEach(radio => {
          if (readOnlyMode) {
            radio.disabled = false;
          } else {
            radio.disabled = !enabled;
          }
        });
        
        // ê²Œì‹œì—¬ë¶€ ë¼ë””ì˜¤ ë²„íŠ¼ë“¤ (í¼ ì™¸ë¶€)
        document.querySelectorAll('input[name="publish"]').forEach(radio => {
          if (readOnlyMode) {
            // ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ê¶Œí•œ í™•ì¸
            const canEdit = selectedNoteId && canEditNote();
            radio.disabled = !canEdit;
          } else {
            radio.disabled = !enabled;
          }
        });
        
        // íƒœê·¸ ì˜ˆì‹œ ë²„íŠ¼ë“¤
        document.querySelectorAll('.tag-example-btn[data-target="mainTag"]').forEach(btn => {
          if (readOnlyMode) {
            btn.disabled = false;
          } else {
            btn.disabled = !enabled;
          }
        });
      }

      // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ (yyyymmdd â†’ yyyy-mm-dd)
      function formatDateForInput(dateString) {
        if (!dateString || dateString.length !== 8) return '';
        const year = dateString.substring(0, 4);
        const month = dateString.substring(4, 6);
        const day = dateString.substring(6, 8);
        return `${year}-${month}-${day}`;
      }

      // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ (yyyy-mm-dd â†’ yyyymmdd)
      function formatDateForStorage(dateString) {
        if (!dateString) return '';
        return dateString.replace(/-/g, '');
      }

      // í…Œì´ë¸” í‘œì‹œìš© ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ (yyyymmdd â†’ yy.mm.dd)
      function formatDateForDisplay(dateString) {
        if (!dateString || dateString.length !== 8) return '';
        const year = dateString.substring(2, 4); // ë…„ë„ ë’¤ 2ìë¦¬ë§Œ
        const month = dateString.substring(4, 6);
        const day = dateString.substring(6, 8);
        return `${year}.${month}.${day}`;
      }

      // ë©”ì¸ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
      function fillMainForm(note) {
        // êµ¬ë¶„ ë¼ë””ì˜¤ ë²„íŠ¼
        const categoryRadio = document.querySelector(`input[name="category"][value="${note.êµ¬ë¶„}"]`);
        if (categoryRadio) categoryRadio.checked = true;
        
        // ë‚ ì§œ (yyyymmdd â†’ yyyy-mm-dd í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
        const formattedDate = formatDateForInput(note.ë…¸íŠ¸ë‚ ì§œ || '');
        document.getElementById('mainDate').value = formattedDate;
        
        // ë…¸íŠ¸ë²ˆí˜¸
        document.getElementById('mainNumber').value = note.ë…¸íŠ¸ë²ˆí˜¸ || '';
        
        // íƒœê·¸ (ì¹© í˜•íƒœ)
        if (window.setTags_mainTag) {
          window.setTags_mainTag(note.íƒœê·¸ || '');
        }
        
        // ë‚´ìš©
        document.getElementById('mainContent').value = note.ë…¸íŠ¸ë‚´ìš© || '';
        
        // ê²Œì‹œì—¬ë¶€ ë¼ë””ì˜¤ ë²„íŠ¼
        const publishRadio = document.querySelector(`input[name="publish"][value="${note.ê²Œì‹œì—¬ë¶€ || 'Y'}"]`);
        if (publishRadio) publishRadio.checked = true;
      }

      // ë©”ì¸ í¼ ì´ˆê¸°í™”
      async function resetMainForm() {
        // í¼ ë¦¬ì…‹
        document.getElementById('mainNoteForm').reset();
        
        // ê¸°ë³¸ê°’ ì„¤ì •
        document.querySelector('input[name="category"][value="ì„¼í„°ì¥"]').checked = true;
        document.querySelector('input[name="publish"][value="Y"]').checked = true;
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        // íƒœê·¸ ì´ˆê¸°í™”
        if (window.setTags_mainTag) {
          window.setTags_mainTag('');
        }
        
        // ë…¸íŠ¸ë²ˆí˜¸ ì¬ìƒì„±
        await updateNoteNumber();
        
        // ì‘ì„± ëª¨ë“œë¡œ ì „í™˜
        setWriteMode();
      }

      // ë…¸íŠ¸ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      async function updateNoteNumber() {
        const dateValue = document.getElementById('mainDate').value;
        if (dateValue && currentUser) {
          try {
            // yyyy-mm-dd â†’ yyyymmdd í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const formattedDate = formatDateForStorage(dateValue);
            const noteNumber = await generateNoteNumber(currentUser, formattedDate);
            document.getElementById('mainNumber').value = noteNumber;
          } catch (error) {
            console.error('ë…¸íŠ¸ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨:', error);
          }
        }
      }

      // ì§ì› ì •ë³´ ë¡œë“œ (ìºì‹œ ì‚¬ìš©)
      async function loadUserInfo() {
        try {
          console.log('=== ì§ì› ì •ë³´ ë¡œë“œ ì‹œì‘ ===');
          console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
          
          // ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¨¼ì € ë¡œë”©
          if (!employeesCacheLoaded) {
            console.log('ì§ì› ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•ŠìŒ - ì´ˆê¸°í™” ì‹œì‘');
            await initializeEmployeesCache();
          }
          
          console.log('ì§ì› ìºì‹œ ìƒíƒœ:', employeesCacheLoaded);
          console.log('ìºì‹œëœ ì§ì› ìˆ˜:', employeesCache ? employeesCache.length : 0);
          
          if (employeesCache && employeesCache.length > 0) {
            console.log('ìºì‹œëœ ì§ì› ëª©ë¡ (ì²« 3ëª…):', employeesCache.slice(0, 3));
            
            // í˜„ì¬ ì‚¬ìš©ìì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì§ì› ì°¾ê¸°
            const matchedEmployee = employeesCache.find(emp => {
              console.log(`ë¹„êµ: "${emp.ì§ì›ë²ˆí˜¸}" === "${currentUser}"`, emp.ì§ì›ë²ˆí˜¸ === currentUser);
              return emp.ì§ì›ë²ˆí˜¸ === currentUser;
            });
            
            console.log('ë§¤ì¹­ëœ ì§ì›:', matchedEmployee);
          }
          
          // ìºì‹œì—ì„œ ì§ì›ëª… ì°¾ê¸°
          currentUserName = getEmployeeNameFromCache(currentUser);
          console.log('ì¡°íšŒëœ ì§ì›ëª…:', currentUserName);
          
          if (currentUserName === currentUser) {
            currentUserName = 'ì•Œ ìˆ˜ ì—†ìŒ';
            console.log('ì§ì›ëª…ì„ ì°¾ì§€ ëª»í•¨ - "ì•Œ ìˆ˜ ì—†ìŒ"ìœ¼ë¡œ ì„¤ì •');
          }

          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
          
          console.log('=== ì§ì› ì •ë³´ ë¡œë“œ ì™„ë£Œ ===');
        } catch (error) {
          console.error('ì§ì› ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
          currentUserName = 'ì•Œ ìˆ˜ ì—†ìŒ';
          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
        }
      }

                         // ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ (ë‚ ì§œ ë²”ìœ„ ê¸°ë°˜)
      async function loadNotes() {
        try {
          console.log('=== ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì‹œì‘ ===');
          
          // ì§ì› ìœ íš¨ì„± ê²€ì‚¬ - ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì„œë²„ ìš”ì²­ ì¤‘ë‹¨
          if (!isValidEmployee(currentUser)) {
            console.log('ğŸš« ì§ì›ëª…ë‹¨ì— ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤. ì„œë²„ ìš”ì²­ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
            cachedNotes = []; // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
            displayNotes(cachedNotes); // ë¹ˆ í…Œì´ë¸” í‘œì‹œ
            return;
          }
          
          // ë‚ ì§œ ë²”ìœ„ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™”
          if (!currentDateRange.startDate || !currentDateRange.endDate) {
            initializeDateRange();
          }
          
          console.log('ë‚ ì§œ ë²”ìœ„:', currentDateRange);
          console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
          
          // ì„œë²„ì—ì„œ ë‚ ì§œ ë²”ìœ„ì™€ ê¶Œí•œ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° ì¡°íšŒ
          cachedNotes = await getNoteshareDataByDateRange(
            currentUser, 
            currentDateRange.startDate, 
            currentDateRange.endDate
          );
          
          console.log('ì„œë²„ì—ì„œ ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', cachedNotes.length);
          
          // í˜„ì¬ ê²Œì‹œì—¬ë¶€ í•„í„° ì ìš©
          const publishFilter = document.querySelector('input[name="publishFilter"]:checked')?.value || 'published';
          const filteredNotes = applyPublishFilter(cachedNotes, publishFilter);
          
          notes = filteredNotes;
          displayNotes(notes);
          
          console.log('=== ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ ===');
        } catch (error) {
          console.error('ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ê²Œì‹œì—¬ë¶€ í•„í„° ì ìš©
      function applyPublishFilter(notesList, publishFilter) {
        if (publishFilter === 'published') {
          return notesList.filter(note => note.ê²Œì‹œì—¬ë¶€ === 'Y');
        } else {
          // ì „ì²´ ë³´ê¸°: ì´ë¯¸ ì„œë²„ì—ì„œ ê¶Œí•œ ê¸°ë°˜ìœ¼ë¡œ í•„í„°ë§ë¨
          return notesList;
        }
      }

      // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ (íƒœê·¸, ë‚´ìš©, ì§ì›ëª…)
      function applyClientSideFilters(notesList, filters) {
        let filtered = [...notesList];
        
        // íƒœê·¸ í•„í„°
        if (filters.tag && filters.tag.trim()) {
          const tagKeyword = filters.tag.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.íƒœê·¸ && note.íƒœê·¸.toLowerCase().includes(tagKeyword)
          );
        }
        
        // ë…¸íŠ¸ë‚´ìš© í•„í„°
        if (filters.content && filters.content.trim()) {
          const contentKeyword = filters.content.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.ë…¸íŠ¸ë‚´ìš© && note.ë…¸íŠ¸ë‚´ìš©.toLowerCase().includes(contentKeyword)
          );
        }
        
        // ì§ì›ëª… í•„í„°
        if (filters.author && filters.author.trim()) {
          const authorKeyword = filters.author.trim().toLowerCase();
          filtered = filtered.filter(note => {
            // DBì— ì €ì¥ëœ ì§ì›ëª…ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìºì‹œì—ì„œ ì°¾ê¸°
            let authorName = note.ì§ì›ëª…;
            if (!authorName || authorName === note.ì§ì›ë²ˆí˜¸) {
              authorName = getEmployeeNameFromCache(note.ì§ì›ë²ˆí˜¸);
            }
            return authorName && authorName.toLowerCase().includes(authorKeyword);
          });
        }
        
        return filtered;
      }

      // ë‚ ì§œ ë²”ìœ„ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      function hasDateRangeChanged(newStartDate, newEndDate) {
        return currentDateRange.startDate !== newStartDate || 
               currentDateRange.endDate !== newEndDate;
      }

      // URLì—ì„œ ë¯¼ê°í•œ íŒŒë¼ë¯¸í„° ì œê±° (ë³´ì•ˆ ê°•í™”)
      function cleanUpURL() {
        try {
          const url = new URL(window.location);
          const urlParams = new URLSearchParams(url.search);
          
          // ì§ì›ë²ˆí˜¸ ê´€ë ¨ ë¯¼ê°í•œ íŒŒë¼ë¯¸í„°ë“¤ ì œê±°
          const sensitiveParams = ['empNo', 'userId', 'user', 'employeeId', 'emp_no'];
          let hasChanges = false;
          
          sensitiveParams.forEach(param => {
            if (urlParams.has(param)) {
              urlParams.delete(param);
              hasChanges = true;
            }
          });
          
          // ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ URL ì—…ë°ì´íŠ¸
          if (hasChanges) {
            const cleanSearch = urlParams.toString();
            const cleanUrl = cleanSearch ? `${url.pathname}?${cleanSearch}` : url.pathname;
            
            // ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±° (ë’¤ë¡œê°€ê¸° ë°©ì§€)
            window.history.replaceState({}, document.title, cleanUrl);
            
            console.log('ğŸ”’ ë³´ì•ˆ: URLì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì œê±°ë¨');
            console.log('ì •ë¦¬ ì „:', url.href);
            console.log('ì •ë¦¬ í›„:', window.location.href);
          }
        } catch (error) {
          console.error('URL ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }

      // ì¶”ê°€ ë³´ì•ˆ: í˜ì´ì§€ ì´íƒˆ ì‹œ ë¯¼ê°í•œ ë°ì´í„° ì •ë¦¬ (ì„ íƒì )
      function setupSecurityCleanup() {
        // í˜ì´ì§€ ì´íƒˆ ì‹œ ì˜µì…˜ (ì£¼ì„ ì²˜ë¦¬ë¨ - ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìœ ì§€ë¥¼ ìœ„í•´)
        window.addEventListener('beforeunload', function() {
          // ì™„ì „ ë¡œê·¸ì•„ì›ƒ ì‹œì—ë§Œ ì •ë¦¬í•˜ë„ë¡ ì„ íƒì  ì‚¬ìš©
          // clearUserInfoFromStorage();
        });
        
        // ë¸Œë¼ìš°ì € íƒ­ ë¹„í™œì„±í™” ì‹œ ì¶”ê°€ ë³´ì•ˆ (ì„ íƒì )
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            console.log('ğŸ”’ íƒ­ ë¹„í™œì„±í™” - ë³´ì•ˆ ëª¨ë“œ');
            // í•„ìš”ì‹œ ì—¬ê¸°ì„œ ì¶”ê°€ ë³´ì•ˆ ì¡°ì¹˜
          }
        });

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ìˆë‹¤ë©´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            clearUserInfoFromStorage();
            console.log('ğŸšª ë¡œê·¸ì•„ì›ƒ - ì €ì¥ëœ ì •ë³´ ì •ë¦¬');
          });
        }
      }

      // ë…¸íŠ¸ë²ˆí˜¸ì—ì„œ ë§ˆì§€ë§‰ ë²ˆí˜¸ë§Œ ì¶”ì¶œ
      function extractNoteSequence(noteNumber) {
        if (!noteNumber) return '-';
        const parts = noteNumber.split('-');
        return parts.length > 0 ? parts[parts.length - 1] : '-';
      }

      // ë…¸íŠ¸ ëª©ë¡ í‘œì‹œ
      function displayNotes(notesToDisplay) {
        const tbody = document.getElementById('notesTableBody');
        tbody.innerHTML = '';

        // ê¸°ë³¸ ì •ë ¬: ë…¸íŠ¸ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ, ì§ì›ëª… ì˜¤ë¦„ì°¨ìˆœ, ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœ
        const sortedNotes = [...notesToDisplay].sort((a, b) => {
          // 1ìˆœìœ„: ë…¸íŠ¸ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ
          const dateA = a.ë…¸íŠ¸ë‚ ì§œ || '';
          const dateB = b.ë…¸íŠ¸ë‚ ì§œ || '';
          if (dateA !== dateB) {
            return dateB.localeCompare(dateA); // ë‚´ë¦¼ì°¨ìˆœ
          }
          
          // 2ìˆœìœ„: ì§ì›ëª… ì˜¤ë¦„ì°¨ìˆœ
          const nameA = a.ì§ì›ëª… || getEmployeeNameFromCache(a.ì§ì›ë²ˆí˜¸) || a.ì§ì›ë²ˆí˜¸ || '';
          const nameB = b.ì§ì›ëª… || getEmployeeNameFromCache(b.ì§ì›ë²ˆí˜¸) || b.ì§ì›ë²ˆí˜¸ || '';
          if (nameA !== nameB) {
            return nameA.localeCompare(nameB); // ì˜¤ë¦„ì°¨ìˆœ
          }
          
          // 3ìˆœìœ„: ë…¸íŠ¸ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœ
          const numberA = a.ë…¸íŠ¸ë²ˆí˜¸ || '';
          const numberB = b.ë…¸íŠ¸ë²ˆí˜¸ || '';
          return numberA.localeCompare(numberB); // ì˜¤ë¦„ì°¨ìˆœ
        });

        sortedNotes.forEach(note => {
          const row = document.createElement('tr');
          row.setAttribute('data-note-id', note.id);
          
          // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (yyyymmdd â†’ yy.mm.dd)
          const displayDate = formatDateForDisplay(note.ë…¸íŠ¸ë‚ ì§œ || '');
          
          // ì§ì›ëª… ì²˜ë¦¬: ì €ì¥ëœ ì§ì›ëª…ì´ ì—†ê±°ë‚˜ ì§ì›ë²ˆí˜¸ì™€ ê°™ìœ¼ë©´ ìºì‹œì—ì„œ ì°¾ê¸°
          let authorName = note.ì§ì›ëª…;
          if (!authorName || authorName === note.ì§ì›ë²ˆí˜¸) {
            authorName = getEmployeeNameFromCache(note.ì§ì›ë²ˆí˜¸);
          }
          
          row.innerHTML = `
            <td class="col-category">${note.êµ¬ë¶„ || '-'}</td>
            <td class="col-date">${displayDate || '-'}</td>
            <td class="col-author">${authorName || note.ì§ì›ë²ˆí˜¸ || '-'}</td>
            <td class="col-number">${extractNoteSequence(note.ë…¸íŠ¸ë²ˆí˜¸)}</td>
            <td class="col-tag">${note.íƒœê·¸ || '-'}</td>
            <td class="col-content">${note.ë…¸íŠ¸ë‚´ìš© || ''}</td>
            <td class="col-publish">${note.ê²Œì‹œì—¬ë¶€ || 'Y'}</td>
          `;
          
          // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (ì¡°íšŒ ëª¨ë“œ)
          row.addEventListener('dblclick', () => {
            selectNoteForView(note, row);
          });
          
          tbody.appendChild(row);
        });
      }

      // ë…¸íŠ¸ ì¡°íšŒ ëª¨ë“œë¡œ ì„ íƒ
      function selectNoteForView(note, row) {
        // í…Œì´ë¸” í–‰ ì„ íƒ í‘œì‹œ
        document.querySelectorAll('#notesTableBody tr').forEach(r => {
          r.classList.remove('selected');
        });
        row.classList.add('selected');

        // ì¡°íšŒ ëª¨ë“œë¡œ ì „í™˜
        setViewMode(note);
      }

      // í…Œì´ë¸”ì—ì„œ íŠ¹ì • ë…¸íŠ¸ í–‰ ì„ íƒ
      function selectTableRow(noteId) {
        // ëª¨ë“  í–‰ ì„ íƒ í•´ì œ
        document.querySelectorAll('#notesTableBody tr').forEach(row => {
          row.classList.remove('selected');
        });
        
        // í•´ë‹¹ ë…¸íŠ¸ IDì˜ í–‰ ì°¾ì•„ì„œ ì„ íƒ
        const targetRow = document.querySelector(`#notesTableBody tr[data-note-id="${noteId}"]`);
        if (targetRow) {
          targetRow.classList.add('selected');
          console.log('ğŸ“ í…Œì´ë¸” í–‰ ì„ íƒ:', noteId);
        } else {
          console.log('âš ï¸ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ë…¸íŠ¸ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', noteId);
        }
      }

      // í…Œì´ë¸” ì •ë ¬ í•¨ìˆ˜
      function sortTable(column) {
        // í˜„ì¬ ì •ë ¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
        updateSortArrows();

        // í˜„ì¬ í‘œì‹œëœ ë…¸íŠ¸ë“¤ì„ ì •ë ¬í•˜ì—¬ ë‹¤ì‹œ í‘œì‹œ
        const currentNotes = getCurrentDisplayedNotes();
        const sortedNotes = sortNotes(currentNotes, column, currentSort.direction);
        displaySortedNotes(sortedNotes);
      }

      // ë…¸íŠ¸ ë°°ì—´ ì •ë ¬
      function sortNotes(notes, column, direction) {
        return [...notes].sort((a, b) => {
          let valueA, valueB;

          switch (column) {
            case 'êµ¬ë¶„':
              valueA = a.êµ¬ë¶„ || '';
              valueB = b.êµ¬ë¶„ || '';
              break;
            case 'ë…¸íŠ¸ë‚ ì§œ':
              valueA = a.ë…¸íŠ¸ë‚ ì§œ || '';
              valueB = b.ë…¸íŠ¸ë‚ ì§œ || '';
              break;
            case 'ì§ì›ëª…':
              valueA = a.ì§ì›ëª… || getEmployeeNameFromCache(a.ì§ì›ë²ˆí˜¸) || a.ì§ì›ë²ˆí˜¸ || '';
              valueB = b.ì§ì›ëª… || getEmployeeNameFromCache(b.ì§ì›ë²ˆí˜¸) || b.ì§ì›ë²ˆí˜¸ || '';
              break;
            case 'ë…¸íŠ¸ë²ˆí˜¸':
              valueA = a.ë…¸íŠ¸ë²ˆí˜¸ || '';
              valueB = b.ë…¸íŠ¸ë²ˆí˜¸ || '';
              break;
            case 'íƒœê·¸':
              valueA = a.íƒœê·¸ || '';
              valueB = b.íƒœê·¸ || '';
              break;
            case 'ë…¸íŠ¸ë‚´ìš©':
              valueA = a.ë…¸íŠ¸ë‚´ìš© || '';
              valueB = b.ë…¸íŠ¸ë‚´ìš© || '';
              break;
            case 'ê²Œì‹œì—¬ë¶€':
              valueA = a.ê²Œì‹œì—¬ë¶€ || '';
              valueB = b.ê²Œì‹œì—¬ë¶€ || '';
              break;
            default:
              valueA = '';
              valueB = '';
          }

          const result = valueA.localeCompare(valueB);
          return direction === 'desc' ? -result : result;
        });
      }

      // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
      function updateSortArrows() {
        // ëª¨ë“  í™”ì‚´í‘œ ì´ˆê¸°í™”
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
          arrow.textContent = '';
          arrow.className = 'sort-arrow';
        });

        // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì˜ í™”ì‚´í‘œ ì„¤ì •
        if (currentSort.column) {
          const currentHeader = document.querySelector(`th[data-column="${currentSort.column}"] .sort-arrow`);
          if (currentHeader) {
            currentHeader.textContent = currentSort.direction === 'asc' ? ' â†‘' : ' â†“';
            currentHeader.className = `sort-arrow ${currentSort.direction}`;
          }
        }
      }

      // í˜„ì¬ í‘œì‹œëœ ë…¸íŠ¸ë“¤ ê°€ì ¸ì˜¤ê¸°
      function getCurrentDisplayedNotes() {
        const tbody = document.getElementById('notesTableBody');
        const rows = tbody.querySelectorAll('tr');
        const notes = [];
        
        rows.forEach(row => {
          const noteId = row.getAttribute('data-note-id');
          const note = cachedNotes.find(n => n.id === noteId);
          if (note) {
            notes.push(note);
          }
        });
        
        return notes;
      }

      // ì •ë ¬ëœ ë…¸íŠ¸ë“¤ì„ í…Œì´ë¸”ì— í‘œì‹œ (ê¸°ë³¸ ì •ë ¬ ì ìš©í•˜ì§€ ì•ŠìŒ)
      function displaySortedNotes(notesToDisplay) {
        const tbody = document.getElementById('notesTableBody');
        tbody.innerHTML = '';

        notesToDisplay.forEach(note => {
          const row = document.createElement('tr');
          row.setAttribute('data-note-id', note.id);
          
          // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (yyyymmdd â†’ yy.mm.dd)
          const displayDate = formatDateForDisplay(note.ë…¸íŠ¸ë‚ ì§œ || '');
          
          // ì§ì›ëª… ì²˜ë¦¬: ì €ì¥ëœ ì§ì›ëª…ì´ ì—†ê±°ë‚˜ ì§ì›ë²ˆí˜¸ì™€ ê°™ìœ¼ë©´ ìºì‹œì—ì„œ ì°¾ê¸°
          let authorName = note.ì§ì›ëª…;
          if (!authorName || authorName === note.ì§ì›ë²ˆí˜¸) {
            authorName = getEmployeeNameFromCache(note.ì§ì›ë²ˆí˜¸);
          }
          
          row.innerHTML = `
            <td class="col-category">${note.êµ¬ë¶„ || '-'}</td>
            <td class="col-date">${displayDate || '-'}</td>
            <td class="col-author">${authorName || note.ì§ì›ë²ˆí˜¸ || '-'}</td>
            <td class="col-number">${extractNoteSequence(note.ë…¸íŠ¸ë²ˆí˜¸)}</td>
            <td class="col-tag">${note.íƒœê·¸ || '-'}</td>
            <td class="col-content content-preview">${note.ë…¸íŠ¸ë‚´ìš© || '-'}</td>
            <td class="col-publish">${note.ê²Œì‹œì—¬ë¶€ || '-'}</td>
          `;

          // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          row.addEventListener('dblclick', () => loadNoteToForm(note));
          
          tbody.appendChild(row);
        });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupEventListeners() {
         // ê²€ìƒ‰ ê¸°ëŠ¥
         document.getElementById('searchBtn').addEventListener('click', performSearch);
         document.getElementById('resetBtn').addEventListener('click', resetSearch);
         
         // ê²€ìƒ‰ ì…ë ¥ í•„ë“œë“¤ì˜ Enter í‚¤ ì´ë²¤íŠ¸
         ['searchDate', 'searchTag', 'searchContent', 'searchAuthor'].forEach(id => {
           const element = document.getElementById(id);
           if (element) {
             element.addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                 performSearch();
               }
             });
           }
         });

                 // ê²Œì‹œì—¬ë¶€ í•„í„° ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
        document.querySelectorAll('input[name="publishFilter"]').forEach(radio => {
          radio.addEventListener('change', performSearch);
        });

        // í…Œì´ë¸” í—¤ë” í´ë¦­ ì •ë ¬
        document.querySelectorAll('th.sortable').forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortTable(column);
          });
        });

        // ë©”ì¸ í¼ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('saveMainBtn').addEventListener('click', function(e) {
          console.log('ğŸ–±ï¸ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨!');
          console.log('- ë²„íŠ¼ disabled ìƒíƒœ:', e.target.disabled);
          saveMainNote();
        });
        document.getElementById('editMainBtn').addEventListener('click', () => executeDirectEdit());
        document.getElementById('deleteMainBtn').addEventListener('click', deleteMainNote);
        document.getElementById('resetMainBtn').addEventListener('click', resetMainForm);

        // ë‚ ì§œ ë³€ê²½ ì‹œ ë…¸íŠ¸ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        document.getElementById('mainDate').addEventListener('change', updateNoteNumber);

        // íƒœê·¸ ì…ë ¥ ì´ë²¤íŠ¸
        setupTagInput('mainTag', 'mainTagChips', 'mainTagHidden');

        // ê¸°ì¡´ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸ëŠ” ì œê±°ë¨

        // íƒœê·¸ ì˜ˆì‹œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ëª¨ë“  íƒœê·¸ ë²„íŠ¼)
        document.querySelectorAll('.tag-example-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const target = this.dataset.target || 'modalTag';
            addTagFromExample(this.dataset.tag, target);
          });
        });

        // ê¸°ì¡´ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°ë¨
      }

             // ê²€ìƒ‰ ìˆ˜í–‰
             async function performSearch() {
        const startDate = document.getElementById('searchStartDate').value;
        const endDate = document.getElementById('searchEndDate').value;
        const tag = document.getElementById('searchTag').value.trim();
        const content = document.getElementById('searchContent').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const publishFilter = document.querySelector('input[name="publishFilter"]:checked').value;

        try {
          // ì§ì› ìœ íš¨ì„± ê²€ì‚¬ - ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì„œë²„ ìš”ì²­ ì¤‘ë‹¨
          if (!isValidEmployee(currentUser)) {
            console.log('ğŸš« ì§ì›ëª…ë‹¨ì— ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤. ê²€ìƒ‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
            cachedNotes = []; // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
            displayNotes(cachedNotes); // ë¹ˆ í…Œì´ë¸” í‘œì‹œ
            return;
          }

          // ë‚ ì§œ ë²”ìœ„ê°€ ë³€ê²½ëœ ê²½ìš° ì„œë²„ì—ì„œ ìƒˆë¡œ ì¡°íšŒ
          if (hasDateRangeChanged(startDate, endDate)) {
            console.log('ë‚ ì§œ ë²”ìœ„ ë³€ê²½ë¨ - ì„œë²„ì—ì„œ ìƒˆë¡œ ì¡°íšŒ');
            
            // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
            currentDateRange.startDate = startDate;
            currentDateRange.endDate = endDate;
            
            // ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ë°ì´í„° ì¡°íšŒ
            cachedNotes = await getNoteshareDataByDateRange(currentUser, startDate, endDate);
            console.log('ìƒˆë¡œ ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', cachedNotes.length);
          }
          
          // ê²Œì‹œì—¬ë¶€ í•„í„° ì ìš©
          let filteredNotes = applyPublishFilter(cachedNotes, publishFilter);
          
          // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„° ì ìš© (íƒœê·¸, ë‚´ìš©, ì§ì›ëª…)
          const clientFilters = { tag, content, author };
          filteredNotes = applyClientSideFilters(filteredNotes, clientFilters);
          
          console.log('ìµœì¢… í•„í„°ë§ëœ ë…¸íŠ¸ ìˆ˜:', filteredNotes.length);
          
          notes = filteredNotes;
          displayNotes(notes);
          
        } catch (error) {
          console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          alert('ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

       // ê²€ìƒ‰ ì´ˆê¸°í™”
       function resetSearch() {
         // ë‚ ì§œ ë²”ìœ„ë¥¼ ê¸°ë³¸ê°’(2ì£¼ ì „~ì˜¤ëŠ˜)ìœ¼ë¡œ ì¬ì„¤ì •
         const dateRange = initializeDateRange();
         document.getElementById('searchStartDate').value = dateRange.startDate;
         document.getElementById('searchEndDate').value = dateRange.endDate;
         
         // ê¸°íƒ€ ê²€ìƒ‰ ì¡°ê±´ ì´ˆê¸°í™”
         document.getElementById('searchTag').value = '';
         document.getElementById('searchContent').value = '';
         document.getElementById('searchAuthor').value = '';
         
         // ê¸°ë³¸ í•„í„° ì„¤ì •
         document.querySelector('input[name="publishFilter"][value="published"]').checked = true;
         
         // ë…¸íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
         loadNotes();
       }

      // ê¸°ì¡´ openModal í•¨ìˆ˜ ì œê±°ë¨ (ì»¤ìŠ¤í…€ ëª¨ë‹¬ë¡œ ëŒ€ì²´)

      // ê¸°ì¡´ fillFormWithSelectedNote í•¨ìˆ˜ ì œê±°ë¨

      // í˜„ì¬ ì„ íƒëœ ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
      function getSelectedNote() {
        return notes.find(note => note.id === selectedNoteId);
      }

      // ê¸°ì¡´ clearForm, closeModal í•¨ìˆ˜ ì œê±°ë¨

      // ê¸°ì¡´ saveNote í•¨ìˆ˜ ì œê±°ë¨ (ì»¤ìŠ¤í…€ ëª¨ë‹¬ë¡œ ëŒ€ì²´)

      // ì„ íƒëœ ë…¸íŠ¸ ì‚­ì œ
      async function deleteSelectedNote() {
        if (!selectedNoteId) {
          alert('ì‚­ì œí•  ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        try {
          const result = await deleteNote(selectedNoteId);
          if (result.success) {
            alert('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            selectedNoteId = null;
            // ìš°ì¸¡ íŒ¨ë„ ì´ˆê¸°í™”
            document.getElementById('detailCategory').textContent = '-';
            document.getElementById('detailDate').textContent = '-';
            document.getElementById('detailNumber').textContent = '-';
            document.getElementById('detailTag').textContent = '-';
            document.getElementById('contentDisplay').textContent = 'ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.';
            document.getElementById('editBtn').disabled = true;
            document.getElementById('deleteBtn').disabled = true;
            
            await loadNotes();
          } else {
            alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ë©”ì¸ í¼ ì €ì¥
      async function saveMainNote() {
        console.log('ğŸ’¾ saveMainNote í•¨ìˆ˜ í˜¸ì¶œë¨!');
        console.log('- isEditMode:', isEditMode);
        console.log('- selectedNoteId:', selectedNoteId);
        
        try {
          // í¼ ìœ íš¨ì„± ê²€ì‚¬
          const form = document.getElementById('mainNoteForm');
          if (!form.checkValidity()) {
            alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }

          // ë…¸íŠ¸ ë°ì´í„° ìˆ˜ì§‘
          const noteData = {
            ì§ì›ë²ˆí˜¸: currentUser,
            ì§ì›ëª…: currentUserName,
            êµ¬ë¶„: document.querySelector('input[name="category"]:checked').value,
            ë…¸íŠ¸ë‚ ì§œ: formatDateForStorage(document.getElementById('mainDate').value),
            ë…¸íŠ¸ë²ˆí˜¸: document.getElementById('mainNumber').value,
            íƒœê·¸: window.getTags_mainTag ? window.getTags_mainTag() : '',
            ë…¸íŠ¸ë‚´ìš©: document.getElementById('mainContent').value,
            ê²Œì‹œì—¬ë¶€: document.querySelector('input[name="publish"]:checked').value
          };

          console.log('ğŸ’¾ ì €ì¥ ë°ì´í„°:', noteData);

          // ì €ì¥ ë²„íŠ¼ì€ í•­ìƒ ì‹ ê·œ ì €ì¥ë§Œ ì²˜ë¦¬
          console.log('âœï¸ ìƒˆ ë…¸íŠ¸ ì €ì¥ ì‹¤í–‰');
          const result = await addNote(noteData);

          // ê²°ê³¼ ì²˜ë¦¬
          if (result.success) {
            await customAlert('ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadNotes();
            await resetMainForm(); // ì‹ ê·œ ì‘ì„± í›„ ì´ˆê¸°í™”
          } else {
            const errorMessage = result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            await customAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
          }

        } catch (error) {
          console.error('ğŸ’¥ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ë…¸íŠ¸ ìˆ˜ì • ì‹¤í–‰ (ì‚­ì œ í›„ ì¬ì €ì¥)
      async function executeNoteUpdate(noteId, updateData) {
        console.log('ğŸ”„ ë…¸íŠ¸ ìˆ˜ì • ì‹œì‘ (ì‚­ì œ í›„ ì¬ì €ì¥):', noteId);
        
        try {
          // ìˆ˜ì • ê¶Œí•œ ì¬í™•ì¸
          if (!canEditNote()) {
            throw new Error('ì´ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ìˆ˜ì •í•  ë…¸íŠ¸ ID í™•ì¸
          if (!noteId) {
            throw new Error('ìˆ˜ì •í•  ë…¸íŠ¸ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

          // 1ë‹¨ê³„: ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ
          console.log('ğŸ—‘ï¸ 1ë‹¨ê³„: ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ');
          const deleteResult = await deleteNote(noteId);
          
          if (!deleteResult.success) {
            throw new Error('ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ' + (deleteResult.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
          
          console.log('âœ… ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ ì™„ë£Œ');

          // 2ë‹¨ê³„: ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì €ì¥
          console.log('ğŸ’¾ 2ë‹¨ê³„: ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì €ì¥');
          const addResult = await addNote(updateData);
          
          if (!addResult.success) {
            throw new Error('ìƒˆ ë…¸íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + (addResult.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
          
          console.log('âœ… ìƒˆ ë…¸íŠ¸ ì €ì¥ ì™„ë£Œ');
          return addResult;

        } catch (error) {
          console.error('âŒ ë…¸íŠ¸ ìˆ˜ì • ì‹¤íŒ¨:', error);
          return { success: false, error: { message: error.message } };
        }
      }

      // ì €ì¥ ê²°ê³¼ ì²˜ë¦¬
      async function handleSaveResult(result, wasEditMode) {
        if (result.success) {
          const message = wasEditMode ? 'ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
          alert(message);
          
          // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
          await loadNotes();
          
          // ì‹ ê·œ ì‘ì„±ì¸ ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
          if (!wasEditMode) {
            await resetMainForm();
          } else {
            // ìˆ˜ì • í›„ì—ëŠ” ìƒˆë¡œ ìƒì„±ëœ ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ì¡°íšŒ ëª¨ë“œë¡œ ì „í™˜
            if (result.data && result.data.id) {
              const newNote = result.data;
              console.log('ğŸ” ìˆ˜ì •ëœ ë…¸íŠ¸ë¡œ ì¡°íšŒ ëª¨ë“œ ì „í™˜:', newNote.id);
              
              // ìƒˆë¡œ ìƒì„±ëœ ë…¸íŠ¸ì˜ ì •ë³´ë¡œ ì¡°íšŒ ëª¨ë“œ ì„¤ì •
              selectedNoteId = newNote.id;
              setViewMode(newNote);
              
              // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ í–‰ ì„ íƒ í‘œì‹œ
              selectTableRow(newNote.id);
            } else {
              // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
              await resetMainForm();
            }
          }
        } else {
          const errorMessage = result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', result.error);
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
        }
      }

      // ë©”ì¸ í¼ ì‚­ì œ
      async function deleteMainNote() {
        if (!selectedNoteId) {
          alert('ì‚­ì œí•  ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        try {
          const result = await deleteNote(selectedNoteId);
          if (result.success) {
            alert('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadNotes();
            await resetMainForm(); // ì‘ì„± ëª¨ë“œë¡œ ë³µê·€
          } else {
            alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // íƒœê·¸ ì…ë ¥ ì„¤ì •
      function setupTagInput(inputId, chipsId, hiddenId) {
        const input = document.getElementById(inputId);
        const chipsContainer = document.getElementById(chipsId);
        const hiddenInput = document.getElementById(hiddenId);
        
        if (!input || !chipsContainer || !hiddenInput) return;

        let tags = [];

        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTagChip(input.value.trim());
          } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
            removeTagChip(tags.length - 1);
          }
        });

        input.addEventListener('blur', function() {
          if (input.value.trim()) {
            addTagChip(input.value.trim());
          }
        });

        function addTagChip(tagText) {
          if (!tagText || tags.includes(tagText)) return;

          tags.push(tagText);
          input.value = '';
          updateChipsDisplay();
          updateHiddenInput();
        }

        function removeTagChip(index) {
          tags.splice(index, 1);
          updateChipsDisplay();
          updateHiddenInput();
        }

        function updateChipsDisplay() {
          chipsContainer.innerHTML = '';
          if (tags.length > 0) {
            tags.forEach((tag, index) => {
              const chip = document.createElement('div');
              chip.className = 'tag-chip';
              chip.innerHTML = `
                <span>${tag}</span>
                <button type="button" class="tag-remove" onclick="removeTagByIndex(${index}, '${inputId}')">&times;</button>
              `;
              chipsContainer.appendChild(chip);
            });
            chipsContainer.style.display = 'flex';
          } else {
            chipsContainer.style.display = 'none';
          }
        }

        function updateHiddenInput() {
          hiddenInput.value = tags.join(', ');
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ íƒœê·¸ ì œê±° ê¸°ëŠ¥ ë…¸ì¶œ
        window[`removeTagByIndex_${inputId}`] = removeTagChip;
        window.removeTagByIndex = function(index, targetInputId) {
          if (targetInputId === inputId) {
            removeTagChip(index);
          }
        };

        // íƒœê·¸ ì„¤ì • í•¨ìˆ˜
        window[`setTags_${inputId}`] = function(tagString) {
          tags = tagString ? tagString.split(',').map(t => t.trim()).filter(t => t) : [];
          updateChipsDisplay();
          updateHiddenInput();
        };

        // íƒœê·¸ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        window[`getTags_${inputId}`] = function() {
          return tags.join(', ');
        };

        // ì´ˆê¸°í™”
        updateChipsDisplay();
      }

      // íƒœê·¸ ì˜ˆì‹œì—ì„œ íƒœê·¸ ì¶”ê°€
      function addTagFromExample(tag, targetId = 'modalTag') {
        if (targetId === 'mainTag') {
          // ì¹© í˜•íƒœ íƒœê·¸ ì¶”ê°€
          const input = document.getElementById(targetId);
          input.value = tag;
          const event = new KeyboardEvent('keydown', { key: 'Enter' });
          input.dispatchEvent(event);
          
          // íšŒì›ìƒë‹´ íƒœê·¸ì¼ ê²½ìš° ë…¸íŠ¸ë‚´ìš©ì— í…œí”Œë¦¿ ì¶”ê°€
          if (tag === 'íšŒì›ìƒë‹´') {
            const contentTextarea = document.getElementById('mainContent');
            const template = `ë³´í˜¸ìì„±í•¨ :
ë³´í˜¸ìì—°ë½ì²˜ :
ì–´ë¥´ì‹ ì„±í•¨ :
ê±°ì£¼ì§€ :
ìš”ì–‘ë“±ê¸‰ì—¬ë¶€ :
ìƒë‹´ë‚´ìš© :
í¬ë§ì‚¬í•­ :
ìš”êµ¬ì‚¬í•­ :`;
            
            // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ í›„ ì¶”ê°€, ì—†ìœ¼ë©´ ë°”ë¡œ ì¶”ê°€
            if (contentTextarea.value.trim()) {
              contentTextarea.value += '\n\n' + template;
            } else {
              contentTextarea.value = template;
            }
          }
        } else {
          // ê¸°ì¡´ ë°©ì‹ (ëª¨ë‹¬)
          const tagInput = document.getElementById(targetId);
          const currentTags = tagInput.value.trim();
          
          const tagArray = currentTags ? currentTags.split(',').map(t => t.trim()) : [];
          
          if (!tagArray.includes(tag)) {
            const newValue = currentTags ? currentTags + ', ' + tag : tag;
            tagInput.value = newValue;
          }
          
          tagInput.focus();
        }
      }

      /*******************************************
       * ì»¤ìŠ¤í…€ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
       *******************************************/

      // ì»¤ìŠ¤í…€ Alert í•¨ìˆ˜
      function customAlert(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('customAlertModal');
          const messageElement = document.getElementById('alertMessage');
          const okBtn = document.getElementById('alertOkBtn');
          
          messageElement.textContent = message;
          modal.style.display = 'block';
          
          function closeAlert() {
            modal.style.display = 'none';
            okBtn.removeEventListener('click', closeAlert);
            document.removeEventListener('keydown', handleKeyDown);
            resolve();
          }
          
          function handleKeyDown(e) {
            if (e.key === 'Enter' || e.key === 'Escape') {
              closeAlert();
            }
          }
          
          okBtn.addEventListener('click', closeAlert);
          document.addEventListener('keydown', handleKeyDown);
          
          // í¬ì»¤ìŠ¤ ì„¤ì •
          setTimeout(() => okBtn.focus(), 100);
        });
      }

      // ì»¤ìŠ¤í…€ Confirm í•¨ìˆ˜
      function customConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('customConfirmModal');
          const messageElement = document.getElementById('confirmMessage');
          const okBtn = document.getElementById('confirmOkBtn');
          const cancelBtn = document.getElementById('confirmCancelBtn');
          
          messageElement.textContent = message;
          modal.style.display = 'block';
          
          function closeConfirm(result) {
            modal.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleKeyDown);
            resolve(result);
          }
          
          function handleOk() {
            closeConfirm(true);
          }
          
          function handleCancel() {
            closeConfirm(false);
          }
          
          function handleKeyDown(e) {
            if (e.key === 'Enter') {
              closeConfirm(true);
            } else if (e.key === 'Escape') {
              closeConfirm(false);
            }
          }
          
          okBtn.addEventListener('click', handleOk);
          cancelBtn.addEventListener('click', handleCancel);
          document.addEventListener('keydown', handleKeyDown);
          
          // í¬ì»¤ìŠ¤ ì„¤ì •
          setTimeout(() => cancelBtn.focus(), 100);
        });
      }

      // ê¸°ì¡´ alertì™€ confirmì„ ì»¤ìŠ¤í…€ ëª¨ë‹¬ë¡œ ëŒ€ì²´
      window.alert = customAlert;
      window.confirm = customConfirm;
    </script>
  </body>
</html>

